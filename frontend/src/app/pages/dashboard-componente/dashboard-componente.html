<div class="dashboard-container" [class.loading]="isLoading()">
  <!-- Loading Overlay -->
  <div *ngIf="isLoading()" class="loading-overlay">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-3 text-muted">Cargando dashboard...</p>
  </div>

  <!-- Header -->
  <div class="dashboard-header bg-white shadow-sm rounded-3 mb-4 p-4">
    <div class="row align-items-center">
      <div class="col-md-6">
        <h1 class="h3 mb-0 text-primary">
          <i class="bi bi-speedometer2 me-2"></i>Dashboard Administrativo
        </h1>
        <p class="text-muted mb-0">Panel de control y estadísticas de OTs</p>
      </div>
      <div class="col-md-6 text-end">
        <div class="btn-group" role="group">
          <button class="btn btn-outline-primary" (click)="refreshDashboard()" [disabled]="isRefreshing()">
            <i class="bi" [class.bi-arrow-clockwise]="!isRefreshing()" [class.bi-arrow-repeat]="isRefreshing()" [class.spin]="isRefreshing()"></i>
            {{ isRefreshing() ? 'Actualizando...' : 'Actualizar' }}
          </button>
          <button class="btn btn-outline-secondary" (click)="showFiltros = !showFiltros">
            <i class="bi bi-funnel"></i> Filtros
          </button>
          <button class="btn btn-outline-success" (click)="exportarDashboard()">
            <i class="bi bi-download"></i> Exportar
          </button>
        </div>
      </div>
    </div>

    <!-- Filtro rápido por rango -->
    <div class="row mt-3">
      <div class="col-md-4">
        <div class="input-group">
          <span class="input-group-text bg-light">
            <i class="bi bi-calendar3"></i>
          </span>
          <select class="form-select" [(ngModel)]="selectedRango" (change)="aplicarFiltroRango()">
            <option *ngFor="let rango of rangos" [value]="rango.value">{{ rango.label }}</option>
          </select>
          <button class="btn btn-light" type="button" (click)="limpiarFiltros()">
            <i class="bi bi-x-circle"></i>
          </button>
        </div>
      </div>
      <div class="col-md-8">
        <div class="text-muted small">
          <i class="bi bi-info-circle me-1"></i>
          Mostrando datos del {{ getRangoLabel(selectedRango()) }}. Última actualización: {{ formatFecha(fechaActualISO) }}
        </div>
      </div>
    </div>

    <!-- Filtros avanzados -->
    <div *ngIf="showFiltros" class="filtros-avanzados mt-3 p-3 bg-light rounded">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label small text-muted">Fecha Inicio</label>
          <input type="date" class="form-control form-control-sm" [(ngModel)]="filtro.fechaInicio">
        </div>
        <div class="col-md-3">
          <label class="form-label small text-muted">Fecha Fin</label>
          <input type="date" class="form-control form-control-sm" [(ngModel)]="filtro.fechaFin">
        </div>
        <div class="col-md-2">
          <label class="form-label small text-muted">Cliente</label>
          <input type="number" class="form-control form-control-sm" [(ngModel)]="filtro.clienteId" placeholder="ID Cliente">
        </div>
        <div class="col-md-2">
          <label class="form-label small text-muted">Área</label>
          <input type="number" class="form-control form-control-sm" [(ngModel)]="filtro.areaId" placeholder="ID Área">
        </div>
        <div class="col-md-2">
          <label class="form-label small text-muted">Proyecto</label>
          <input type="number" class="form-control form-control-sm" [(ngModel)]="filtro.proyectoId" placeholder="ID Proyecto">
        </div>
        <div class="col-12 text-end">
          <button class="btn btn-primary btn-sm" (click)="aplicarFiltrosAvanzados()">
            <i class="bi bi-check-lg"></i> Aplicar Filtros
          </button>
          <button class="btn btn-outline-secondary btn-sm ms-2" (click)="limpiarFiltros()">
            <i class="bi bi-x-lg"></i> Limpiar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Estadísticas Generales -->
  <div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card bg-primary text-white shadow h-100 border-0">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs fw-bold text-uppercase mb-1">Total OTs</div>
              <div class="h5 mb-0 fw-bold">{{ estadisticas()?.totalOTs || 0 }}</div>
              <div class="mt-2 small">
                <i class="bi bi-arrow-up me-1"></i>
                {{ estadisticas()?.otsEsteMes || 0 }} este mes
              </div>
            </div>
            <div class="col-auto">
              <i class="bi bi-clipboard-data fa-2x text-white-50"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card bg-success text-white shadow h-100 border-0">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs fw-bold text-uppercase mb-1">OTs Activas</div>
              <div class="h5 mb-0 fw-bold">{{ estadisticas()?.otsActivas || 0 }}</div>
              <div class="mt-2 small">
                {{ calcularPorcentaje(estadisticas()?.otsActivas || 0, estadisticas()?.totalOTs || 1) | number:'1.1-1' }}% del total
              </div>
            </div>
            <div class="col-auto">
              <i class="bi bi-gear fa-2x text-white-50"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card bg-info text-white shadow h-100 border-0">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs fw-bold text-uppercase mb-1">Costos Totales</div>
              <div class="h5 mb-0 fw-bold">{{ formatCurrency(estadisticas()?.costoTotalOTs || 0) }}</div>
              <div class="mt-2 small">
                <i class="bi bi-currency-exchange me-1"></i>
                {{ formatCurrency(estadisticas()?.costoPromedioOT || 0) }} por OT
              </div>
            </div>
            <div class="col-auto">
              <i class="bi bi-cash-stack fa-2x text-white-50"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card bg-warning text-white shadow h-100 border-0">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs fw-bold text-uppercase mb-1">OTs Pendientes</div>
              <div class="h5 mb-0 fw-bold">{{ estadisticas()?.otsPendientes || 0 }}</div>
              <div class="mt-2 small">
                <i class="bi bi-clock-history me-1"></i>
                {{ otsPendientes().length }} con detalles
              </div>
            </div>
            <div class="col-auto">
              <i class="bi bi-clock fa-2x text-white-50"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráficos principales -->
  <div class="row mb-4">
    <!-- Gráfico de Estados -->
    <div class="col-xl-4 col-lg-6 mb-4">
      <div class="card shadow h-100 border-0">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center border-0">
          <h6 class="m-0 fw-bold text-primary">
            <i class="bi bi-pie-chart me-2"></i>OTs por Estado
          </h6>
          <span class="badge bg-light text-dark">{{ otsPorEstado().length }} estados</span>
        </div>
        <div class="card-body">
          <div class="chart-container" style="position: relative; height: 300px;">
            <canvas #chartEstados></canvas>
          </div>
          <div class="mt-3 small text-muted">
           Total: {{ getTotalOts() }} OTs

          </div>
        </div>
      </div>
    </div>

    <!-- Gráfico de Costos -->
    <div class="col-xl-8 col-lg-6 mb-4">
      <div class="card shadow h-100 border-0">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center border-0">
          <h6 class="m-0 fw-bold text-primary">
            <i class="bi bi-bar-chart me-2"></i>Distribución de Costos
          </h6>
          <span class="badge bg-light text-dark">{{ formatCurrency(resumenCostos()?.costoTotal || 0) }}</span>
        </div>
        <div class="card-body">
          <div class="chart-container" style="position: relative; height: 300px;">
            <canvas #chartCostos></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Evolución y Top Clientes -->
  <div class="row mb-4">
    <!-- Evolución Mensual -->
    <div class="col-xl-8 mb-4">
      <div class="card shadow h-100 border-0">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center border-0">
          <h6 class="m-0 fw-bold text-primary">
            <i class="bi bi-graph-up me-2"></i>Evolución Mensual
          </h6>
          <div class="small text-muted">Últimos 6 meses</div>
        </div>
        <div class="card-body">
          <div class="chart-container" style="position: relative; height: 300px;">
            <canvas #chartEvolucion></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Top 10 Clientes -->
    <div class="col-xl-4 mb-4">
      <div class="card shadow h-100 border-0">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center border-0">
          <h6 class="m-0 fw-bold text-primary">
            <i class="bi bi-people me-2"></i>Top 10 Clientes
          </h6>
          <span class="badge bg-light text-dark">Por cantidad de OTs</span>
        </div>
        <div class="card-body p-0">
          <div class="chart-container" style="position: relative; height: 300px;">
            <canvas #chartClientes></canvas>
          </div>
          <div class="table-responsive">
            <table class="table table-sm table-hover mb-0">
              <tbody>
                <tr *ngFor="let cliente of otsPorCliente().slice(0, 5); let i = index">
                  <td class="ps-3">
                    <span class="badge bg-light text-dark me-2">#{{ i + 1 }}</span>
                    {{ cliente.cliente.length > 25 ? cliente.cliente.substring(0, 25) + '...' : cliente.cliente }}
                  </td>
                  <td class="text-end pe-3">
                    <span class="badge" [ngStyle]="{'background-color': getColorEstado('EN PROCESO')}">
                      {{ cliente.cantidad }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- OTs Pendientes -->
  <div class="row">
    <div class="col-12">
      <div class="card shadow border-0">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center border-0">
          <h6 class="m-0 fw-bold text-primary">
            <i class="bi bi-exclamation-triangle me-2"></i>OTs Pendientes de Atención
          </h6>
          <span class="badge bg-warning text-dark">{{ otsPendientes().length }} pendientes</span>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th class="ps-3">OT</th>
                  <th>Cliente</th>
                  <th>Descripción</th>
                  <th>Estado</th>
                  <th>Fecha Apertura</th>
                  <th>Días</th>
                  <th>Responsable</th>
                  <th class="text-end pe-3">Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let ot of otsPendientes()">
                  <td class="ps-3 fw-bold text-primary">#{{ ot.ot }}</td>
                  <td>
                    <div class="d-flex align-items-center">
                      <i class="bi bi-building me-2 text-muted"></i>
                      {{ ot.cliente.length > 20 ? ot.cliente.substring(0, 20) + '...' : ot.cliente }}
                    </div>
                  </td>
                  <td>
                    <span class="text-truncate d-inline-block" style="max-width: 200px;"
                          [title]="ot.descripcion">
                      {{ ot.descripcion.length > 30 ? ot.descripcion.substring(0, 30) + '...' : ot.descripcion }}
                    </span>
                  </td>
                  <td>
                    <span class="badge" [ngStyle]="{'background-color': getColorEstado(ot.estado)}">
                      <i [class]="getIconEstado(ot.estado) + ' me-1'"></i>
                      {{ ot.estado }}
                    </span>
                  </td>
                  <td>
                    <span class="text-muted">{{ formatFecha(ot.fechaApertura) }}</span>
                  </td>
                  <td>
                    <span class="badge" [ngClass]="{
                      'bg-danger': ot.diasPendientes > 30,
                      'bg-warning': ot.diasPendientes > 7 && ot.diasPendientes <= 30,
                      'bg-info': ot.diasPendientes <= 7
                    }">
                      {{ ot.diasPendientes }} días
                    </span>
                  </td>
                  <td>
                    <div class="d-flex align-items-center">
                      <i class="bi bi-person-circle me-2 text-muted"></i>
                      {{ ot.responsable }}
                    </div>
                  </td>
                  <td class="text-end pe-3">
                    <div class="btn-group btn-group-sm" role="group">
                      <button class="btn btn-outline-primary" (click)="verDetalleOT(ot)">
                        <i class="bi bi-eye"></i>
                      </button>

                    </div>
                  </td>
                </tr>
                <tr *ngIf="otsPendientes().length === 0">
                  <td colspan="8" class="text-center py-4 text-muted">
                    <i class="bi bi-check-circle display-6 text-success mb-3"></i>
                    <p class="mb-0">¡Excelente! No hay OTs pendientes.</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="mt-4 text-center text-muted small">
    <p class="mb-0">
      <i class="bi bi-shield-check me-1"></i>
      Sistema de Gestión de OTs - Dashboard Administrativo v1.0
    </p>
    <p class="mb-0">Los datos se actualizan automáticamente cada 5 minutos</p>
  </div>
</div>
