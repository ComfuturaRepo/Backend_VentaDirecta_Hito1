<!-- gestion-permisos.component.html -->
<div class="container-fluid py-4">
  <!-- Header Principal -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border shadow-sm">
        <div class="card-body p-4">
          <div class="row align-items-center">
            <div class="col-md-8">
              <div class="d-flex align-items-center mb-3">
                <div class="bg-primary bg-opacity-10 p-3 rounded-3 me-3">
                  <i class="bi bi-shield-check fs-2 text-primary"></i>
                </div>
                <div>
                  <h1 class="h4 fw-bold mb-1">Gestión de Permisos</h1>
                  <p class="text-muted mb-0">Administre los permisos de acceso del sistema</p>
                </div>
              </div>

              <div class="d-flex align-items-center flex-wrap gap-4">
                <div class="d-flex align-items-center">
                  <div class="bg-primary bg-opacity-10 p-2 rounded me-2">
                    <i class="bi bi-list-check text-primary"></i>
                  </div>
                  <div>
                    <div class="text-muted small">Total</div>
                    <div class="fw-bold">{{totalItems}}</div>
                  </div>
                </div>

                <div class="d-flex align-items-center">
                  <div class="bg-success bg-opacity-10 p-2 rounded me-2">
                    <i class="bi bi-check-circle text-success"></i>
                  </div>
                  <div>
                    <div class="text-muted small">Activos</div>
                    <div class="fw-bold text-success">{{getPermisosActivos()}}</div>
                  </div>
                </div>

                <div class="d-flex align-items-center">
                  <div class="bg-danger bg-opacity-10 p-2 rounded me-2">
                    <i class="bi bi-x-circle text-danger"></i>
                  </div>
                  <div>
                    <div class="text-muted small">Inactivos</div>
                    <div class="fw-bold text-danger">{{getPermisosInactivos()}}</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-md-4 mt-3 mt-md-0">
              <div class="d-grid gap-2">
                <button class="btn btn-outline-primary d-flex align-items-center justify-content-center"
                        (click)="onRefresh()"
                        [disabled]="cargandoPermisos">
                  <i class="bi bi-arrow-clockwise me-2" [class.spin]="cargandoPermisos"></i>
                  Actualizar
                </button>
                <button class="btn btn-primary d-flex align-items-center justify-content-center"
                        (click)="mostrarFormularioNuevo()">
                  <i class="bi bi-plus-circle me-2"></i>
                  Nuevo Permiso
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border shadow-sm">
        <div class="card-header bg-white py-3 border-bottom">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <i class="bi bi-funnel me-2 text-primary"></i>
              <h6 class="mb-0 fw-semibold">Filtros de Búsqueda</h6>
            </div>
            <button class="btn btn-sm btn-outline-secondary"
                    (click)="limpiarFiltros()"
                    [disabled]="!filtroCodigo && !filtroNombre && filtroNivel === 0 && filtroArea === 0 && filtroEstado === 'all'">
              <i class="bi bi-x-circle me-1"></i>
              Limpiar
            </button>
          </div>
        </div>

        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6 col-lg-3">
              <label class="form-label small fw-semibold">Código</label>
              <div class="input-group input-group-sm">
                <span class="input-group-text bg-white">
                  <i class="bi bi-hash text-muted"></i>
                </span>
                <input type="text"
                       class="form-control"
                       placeholder="Buscar por código..."
                       [(ngModel)]="filtroCodigo"
                       (input)="aplicarFiltros()">
              </div>
            </div>

            <div class="col-md-6 col-lg-3">
              <label class="form-label small fw-semibold">Nombre</label>
              <div class="input-group input-group-sm">
                <span class="input-group-text bg-white">
                  <i class="bi bi-search text-muted"></i>
                </span>
                <input type="text"
                       class="form-control"
                       placeholder="Buscar por nombre..."
                       [(ngModel)]="filtroNombre"
                       (input)="aplicarFiltros()">
              </div>
            </div>

            <div class="col-md-6 col-lg-2">
              <label class="form-label small fw-semibold">Nivel</label>
              <select class="form-select form-select-sm"
                      [(ngModel)]="filtroNivel"
                      (change)="aplicarFiltros()">
                <option [value]="0">Todos</option>
                <option *ngFor="let nivel of niveles" [value]="nivel.id">{{nivel.label}}</option>
              </select>
            </div>

            <div class="col-md-6 col-lg-2">
              <label class="form-label small fw-semibold">Área</label>
              <select class="form-select form-select-sm"
                      [(ngModel)]="filtroArea"
                      (change)="aplicarFiltros()">
                <option [value]="0">Todas</option>
                <option *ngFor="let area of areas" [value]="area.id">{{area.label}}</option>
              </select>
            </div>

            <div class="col-md-6 col-lg-2">
              <label class="form-label small fw-semibold">Estado</label>
              <select class="form-select form-select-sm"
                      [(ngModel)]="filtroEstado"
                      (change)="aplicarFiltros()">
                <option value="all">Todos</option>
                <option value="true">Activo</option>
                <option value="false">Inactivo</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla -->
  <div class="row">
    <div class="col-12">
      <div class="card border shadow-sm">
        <div class="card-header bg-white py-3 border-bottom">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <i class="bi bi-table me-2 text-primary"></i>
              <h6 class="mb-0 fw-semibold">Lista de Permisos</h6>
            </div>
            <div class="text-muted small">
              <span class="me-3">Mostrando {{permisosFiltrados.length}} de {{totalItems}}</span>
              <span class="badge bg-light text-dark">Página {{currentPage + 1}}/{{totalPages}}</span>
            </div>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-borderless table-hover mb-0">
            <thead>
              <tr class="border-bottom">
                <th class="ps-4 text-uppercase small fw-semibold text-muted" style="width: 60px;">ID</th>
                <th class="text-uppercase small fw-semibold text-muted">Código</th>
                <th class="text-uppercase small fw-semibold text-muted">Nombre</th>
                <th class="text-uppercase small fw-semibold text-muted">Descripción</th>
                <th class="text-uppercase small fw-semibold text-muted">Niveles</th>
                <th class="text-uppercase small fw-semibold text-muted">Áreas</th>
                <th class="text-uppercase small fw-semibold text-muted">Cargos</th>
                <th class="text-uppercase small fw-semibold text-muted">Trabajadores</th>
                <th class="text-uppercase small fw-semibold text-muted" style="width: 80px;">Estado</th>
                <th class="text-uppercase small fw-semibold text-muted text-center" style="width: 100px;">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <!-- Loading -->
              <tr *ngIf="cargandoPermisos">
                <td colspan="10" class="text-center py-5">
                  <div class="d-flex flex-column align-items-center">
                    <div class="spinner-border spinner-border-sm text-primary mb-2"></div>
                    <span class="text-muted small">Cargando permisos...</span>
                  </div>
                </td>
              </tr>

              <!-- Empty state -->
              <tr *ngIf="mostrarTablaVacia">
                <td colspan="10" class="text-center py-5">
                  <div class="py-4">
                    <i class="bi bi-shield-exclamation display-5 text-muted mb-3"></i>
                    <h6 class="fw-semibold mb-2">
                      {{ filtroCodigo || filtroNombre || filtroNivel || filtroArea || filtroEstado !== 'all' ?
                         'No se encontraron resultados' :
                         'No hay permisos registrados' }}
                    </h6>
                    <p class="text-muted small mb-3">
                      {{ filtroCodigo || filtroNombre || filtroNivel || filtroArea || filtroEstado !== 'all' ?
                         'Intente ajustar los filtros de búsqueda' :
                         'Comience creando el primer permiso' }}
                    </p>
                    <button class="btn btn-sm btn-primary" (click)="mostrarFormularioNuevo()">
                      <i class="bi bi-plus-circle me-1"></i>
                      Crear Permiso
                    </button>
                  </div>
                </td>
              </tr>

              <!-- Permisos -->
              <tr *ngFor="let permiso of permisosFiltrados | slice:0:pageSize"
                  class="border-bottom">
                <td class="ps-4">
                  <span class="text-muted small">#{{permiso.idPermiso}}</span>
                </td>

                <td>
                  <code class="text-primary bg-primary bg-opacity-10 px-2 py-1 rounded border-0 small">{{permiso.codigo}}</code>
                </td>

                <td>
                  <span class="fw-medium">{{permiso.nombre}}</span>
                </td>

                <td>
                  <span class="text-muted small" title="{{permiso.descripcion || 'Sin descripción'}}">
                    {{(permiso.descripcion || 'Sin descripción') | slice:0:40}}
                    {{(permiso.descripcion || '').length > 40 ? '...' : ''}}
                  </span>
                </td>

                <!-- Niveles -->
                <td>
                  <div class="d-flex flex-wrap gap-1">
                    <ng-container *ngIf="permiso.niveles.length > 0; else sinNiveles">
                      <span *ngFor="let nivel of permiso.niveles | slice:0:1"
                            class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25 small">
                        {{nivel.codigo}}
                      </span>
                      <span *ngIf="permiso.niveles.length > 1"
                            class="badge bg-light text-muted border small"
                            title="+{{permiso.niveles.length - 1}} más">
                        +{{permiso.niveles.length - 1}}
                      </span>
                    </ng-container>
                    <ng-template #sinNiveles>
                      <span class="text-muted small">-</span>
                    </ng-template>
                  </div>
                </td>

                <!-- Áreas -->
                <td>
                  <div class="d-flex flex-wrap gap-1">
                    <ng-container *ngIf="permiso.areas.length > 0; else sinAreas">
                      <span *ngFor="let area of permiso.areas | slice:0:1"
                            class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 small">
                        {{area.nombre | slice:0:10}}
                        {{area.nombre.length > 10 ? '...' : ''}}
                      </span>
                      <span *ngIf="permiso.areas.length > 1"
                            class="badge bg-light text-muted border small">
                        +{{permiso.areas.length - 1}}
                      </span>
                    </ng-container>
                    <ng-template #sinAreas>
                      <span class="text-muted small">-</span>
                    </ng-template>
                  </div>
                </td>

                <!-- Cargos -->
                <td>
                  <div class="d-flex flex-wrap gap-1">
                    <ng-container *ngIf="permiso.cargos.length > 0; else sinCargos">
                      <span *ngFor="let cargo of permiso.cargos | slice:0:1"
                            class="badge bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25 small">
                        {{cargo.nombre | slice:0:10}}
                        {{cargo.nombre.length > 10 ? '...' : ''}}
                      </span>
                      <span *ngIf="permiso.cargos.length > 1"
                            class="badge bg-light text-muted border small">
                        +{{permiso.cargos.length - 1}}
                      </span>
                    </ng-container>
                    <ng-template #sinCargos>
                      <span class="text-muted small">-</span>
                    </ng-template>
                  </div>
                </td>

                <!-- Trabajadores -->
                <td>
                  <div class="d-flex flex-wrap gap-1">
                    <ng-container *ngIf="permiso.trabajadores && permiso.trabajadores.length > 0; else sinTrabajadores">
                      <span *ngFor="let trabajador of permiso.trabajadores | slice:0:1"
                            class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 small">
                        {{getNombreTrabajador(trabajador) | slice:0:10}}
                        {{getNombreTrabajador(trabajador).length > 10 ? '...' : ''}}
                      </span>
                      <span *ngIf="permiso.trabajadores.length > 1"
                            class="badge bg-light text-muted border small">
                        +{{permiso.trabajadores.length - 1}}
                      </span>
                    </ng-container>
                    <ng-template #sinTrabajadores>
                      <span class="text-muted small">-</span>
                    </ng-template>
                  </div>
                </td>

                <!-- Estado -->
                <td>
                  <span class="badge d-inline-flex align-items-center small py-1 px-2 rounded"
                        [ngClass]="permiso.activo ?
                          'bg-success bg-opacity-10 text-success border border-success border-opacity-25' :
                          'bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25'">
                    <i class="bi bi-circle-fill me-1"
                       [ngClass]="permiso.activo ? 'text-success' : 'text-danger'"
                       style="font-size: 6px;"></i>
                    {{permiso.activo ? 'Activo' : 'Inactivo'}}
                  </span>
                </td>

                <!-- Acciones -->
                <td class="text-center">
                  <div class="btn-group">
                    <button class="btn btn-sm btn-outline-primary border-end-0"
                            (click)="editarPermiso(permiso)"
                            [disabled]="cargandoPermisos"
                            title="Editar">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger border-start-0"
                            (click)="eliminarPermiso(permiso.idPermiso)"
                            [disabled]="cargandoPermisos"
                            title="Eliminar">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Paginación -->
        <div class="card-footer bg-white py-3 border-top">
          <app-pagination
            [currentPage]="currentPage"
            [totalItems]="totalItems"
            [totalPages]="totalPages"
            [pageSize]="pageSize"
            [showInfo]="true"
            [showSizeSelector]="true"
            [showNavigation]="true"
            [showPageNumbers]="true"
            [pageSizes]="[5, 10, 20, 50]"
            [align]="'center'"
            [size]="'sm'"
            [isLoading]="cargandoPermisos"
            (pageChange)="onPageChange($event)"
            (pageSizeChange)="onPageSizeChange($event)"
            (refresh)="onRefresh()">
          </app-pagination>
        </div>
      </div>
    </div>
  </div>
</div>

<app-permiso-form
  [mostrar]="mostrarModal"
  [modoEdicion]="modoEdicion"
  [permisoSeleccionado]="permisoSeleccionado"
  [niveles]="niveles"
  [areas]="areas"
  [cargos]="cargos"
  [trabajadores]="trabajadores"
  (cerrar)="cerrarModal()"
  (guardado)="onPermisoGuardado()">
</app-permiso-form>
