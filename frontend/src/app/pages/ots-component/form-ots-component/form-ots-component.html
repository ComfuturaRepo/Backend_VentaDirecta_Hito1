<div class="form-ots-container bg-white min-vh-100">
  <!-- Loading -->
  <div *ngIf="loading" class="loading-overlay d-flex align-items-center justify-content-center">
    <div class="text-center">
      <div class="spinner-grow text-primary" style="width: 3.5rem; height: 3.5rem;" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <h5 class="mt-4 text-primary fw-semibold">
        {{ isEditMode ? 'Cargando datos de la OT...' : 'Cargando formulario...' }}
      </h5>
    </div>
  </div>

  <!-- Formulario principal -->
  <ng-container *ngIf="!loading">
    <div class="form-header bg-primary text-white p-4">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <div class="d-flex align-items-center gap-3">
          <div class="header-icon bg-white text-primary rounded-circle p-3 shadow-sm">
            <i class="bi bi-file-earmark-text fs-2"></i>
          </div>
          <div>
            <h3 class="mb-1 fw-bold">
              {{ isEditMode ? 'Editar Orden de Trabajo' : 'Nueva Orden de Trabajo' }}
              <span *ngIf="isEditMode && form.value.idOts" class="badge bg-light text-primary ms-2 fs-6">
                #{{ form.value.idOts }}
              </span>
            </h3>
            <p class="mb-0 opacity-75">
              {{ isEditMode ? 'Modifique los datos necesarios' : 'Complete todos los campos obligatorios' }}
            </p>
          </div>
        </div>

        <!-- Botón cerrar -->
        <button type="button" class="btn-close btn-close-white opacity-75"
                (click)="onCancel()" aria-label="Cerrar">
        </button>
      </div>

      <!-- Usuario logueado -->
      <div class="user-info small bg-primary-dark rounded-pill px-3 py-1 d-inline-flex align-items-center gap-2">
        <i class="bi bi-person-circle"></i>
        <span>{{ usernameLogueado }}</span>
        <span *ngIf="trabajadorIdLogueado" class="opacity-75">
          (ID: {{ trabajadorIdLogueado }})
        </span>
      </div>
    </div>

    <!-- Steps Navigation -->
    <div class="steps-navigation bg-light px-4 py-3 border-bottom">
      <div class="d-flex justify-content-center gap-2">
        <button type="button" class="step-btn rounded-pill px-4 py-2 border-0 fw-medium"
                [class.active]="currentStep === 1"
                [class.completed]="currentStep > 1"
                (click)="cambiarPaso(1)">
          <i class="bi bi-1-circle me-2"></i>
          Información Principal
        </button>
        <div class="step-divider d-flex align-items-center px-2">
          <i class="bi bi-chevron-right text-muted"></i>
        </div>
        <button type="button" class="step-btn rounded-pill px-4 py-2 border-0 fw-medium"
                [class.active]="currentStep === 2"
                [class.completed]="currentStep > 2"
                (click)="cambiarPaso(2)">
          <i class="bi bi-2-circle me-2"></i>
          Responsables
        </button>
        <div class="step-divider d-flex align-items-center px-2">
          <i class="bi bi-chevron-right text-muted"></i>
        </div>
        <button type="button" class="step-btn rounded-pill px-4 py-2 border-0 fw-medium"
                [class.active]="currentStep === 3"
                (click)="cambiarPaso(3)">
          <i class="bi bi-3-circle me-2"></i>
          Confirmar
        </button>
      </div>
    </div>

    <!-- Contenido del formulario con scroll -->
    <div class="form-content-scrollable" #scrollContainer>
      <div class="p-4">
        <form [formGroup]="form" (ngSubmit)="onSubmit()" novalidate>
          <!-- Paso 1: Información Principal -->
          <div *ngIf="currentStep === 1" class="step-content animate__animated animate__fadeIn">
            <h5 class="step-title mb-4 pb-2 border-bottom">
              <i class="bi bi-card-checklist text-primary me-2"></i>
              Información Principal de la OT
              <span class="badge bg-primary-subtle text-primary ms-2 fs-7">Todos obligatorios</span>
            </h5>

            <div class="row g-4">
              <!-- Cliente -->
              <div class="col-md-6">
                <div class="form-group" [class.has-error]="submitted && f['idCliente'].invalid">
                  <label class="form-label fw-medium">
                    Cliente <span class="text-danger">*</span>
                  </label>
                  <ng-select
                    [items]="clientes"
                    bindLabel="label"
                    bindValue="id"
                    [placeholder]="'Seleccione cliente'"
                    [clearable]="true"
                    [searchable]="true"
                    [(ngModel)]="form.value.idCliente"
                    [ngModelOptions]="{standalone: true}"
                    (change)="onClienteChange($event)"
                    [loading]="loading"
                    [class.is-invalid]="submitted && f['idCliente'].invalid">

                    <ng-template ng-label-tmp let-item="item">
                      <span *ngIf="item">
                        {{ getItemDisplay(item) }}
                      </span>
                    </ng-template>

                    <ng-template ng-option-tmp let-item="item">
                      <div class="dropdown-option">
                        <div class="fw-medium">
                          {{ getItemDisplay(item) }}
                        </div>
                        <small *ngIf="item.adicional" class="text-muted">
                          {{ item.adicional }}
                        </small>
                      </div>
                    </ng-template>

                    <ng-template ng-notfound-tmp>
                      <div class="text-center p-2">
                        <i class="bi bi-search text-muted"></i>
                        <p class="mb-0">No se encontraron clientes</p>
                      </div>
                    </ng-template>

                  </ng-select>
                  <div *ngIf="submitted && f['idCliente'].invalid" class="invalid-feedback d-block">
                    Debe seleccionar un cliente
                  </div>
                </div>
              </div>

              <!-- Área -->
              <div class="col-md-6">
                <div class="form-group" [class.has-error]="submitted && f['idArea'].invalid">
                  <label class="form-label fw-medium">
                    Área <span class="text-danger">*</span>
                  </label>
                  <ng-select
                    [items]="areas"
                    bindLabel="label"
                    bindValue="id"
                    [placeholder]="'Seleccione área'"
                    [clearable]="true"
                    [searchable]="true"
                    [(ngModel)]="form.value.idArea"
                    [ngModelOptions]="{standalone: true}"
                    (change)="form.get('idArea')?.setValue($event?.id)"
                    [disabled]="!form.get('idCliente')?.value || loading"
                    [class.is-invalid]="submitted && f['idArea'].invalid">

                    <ng-template ng-label-tmp let-item="item">
                      <span *ngIf="item">
                        {{ getItemDisplay(item) }}
                      </span>
                    </ng-template>

                    <ng-template ng-option-tmp let-item="item">
                      <div class="dropdown-option">
                        <div class="fw-medium">
                          {{ getItemDisplay(item) }}
                        </div>
                        <small *ngIf="item.adicional" class="text-muted">
                          {{ item.adicional }}
                        </small>
                      </div>
                    </ng-template>

                  </ng-select>
                  <div *ngIf="!form.get('idCliente')?.value" class="text-muted small mt-1">
                    <i class="bi bi-info-circle me-1"></i>
                    Seleccione un cliente primero
                  </div>
                  <div *ngIf="submitted && f['idArea'].invalid" class="invalid-feedback d-block">
                    Debe seleccionar un área
                  </div>
                </div>
              </div>

              <!-- Fecha Apertura -->
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label fw-medium">
                    Fecha de Apertura <span class="text-danger">*</span>
                  </label>
                  <input type="date" class="form-control form-control-lg" formControlName="fechaApertura"
                         [class.is-invalid]="submitted && f['fechaApertura'].invalid">
                  <div *ngIf="submitted && f['fechaApertura'].invalid" class="invalid-feedback">
                    Fecha requerida
                  </div>
                </div>
              </div>

              <!-- Proyecto -->
              <div class="col-md-6">
                <div class="form-group" [class.has-error]="submitted && f['idProyecto'].invalid">
                  <label class="form-label fw-medium">
                    Proyecto <span class="text-danger">*</span>
                  </label>
                  <ng-select
                    [items]="proyectos"
                    bindLabel="label"
                    bindValue="id"
                    [placeholder]="'Seleccione proyecto'"
                    [clearable]="true"
                    [searchable]="true"
                    [(ngModel)]="form.value.idProyecto"
                    [ngModelOptions]="{standalone: true}"
                    (change)="form.get('idProyecto')?.setValue($event?.id)"
                    [class.is-invalid]="submitted && f['idProyecto'].invalid">

                    <ng-template ng-label-tmp let-item="item">
                      <span *ngIf="item">
                        {{ getItemDisplay(item) }}
                      </span>
                    </ng-template>

                    <ng-template ng-option-tmp let-item="item">
                      <div class="dropdown-option">
                        <div class="fw-medium">
                          {{ getItemDisplay(item) }}
                        </div>
                        <small *ngIf="item.adicional" class="text-muted">
                          {{ item.adicional }}
                        </small>
                      </div>
                    </ng-template>

                  </ng-select>
                  <div *ngIf="submitted && f['idProyecto'].invalid" class="invalid-feedback d-block">
                    Debe seleccionar un proyecto
                  </div>
                </div>
              </div>

              <!-- Fase -->
              <div class="col-md-6">
                <div class="form-group" [class.has-error]="submitted && f['idFase'].invalid">
                  <label class="form-label fw-medium">
                    Fase <span class="text-danger">*</span>
                  </label>
                  <ng-select
                    [items]="fases"
                    bindLabel="label"
                    bindValue="id"
                    [placeholder]="'Seleccione fase'"
                    [clearable]="true"
                    [searchable]="true"
                    [(ngModel)]="form.value.idFase"
                    [ngModelOptions]="{standalone: true}"
                    (change)="form.get('idFase')?.setValue($event?.id)"
                    [class.is-invalid]="submitted && f['idFase'].invalid">

                    <ng-template ng-label-tmp let-item="item">
                      <span *ngIf="item">
                        {{ getItemDisplay(item) }}
                      </span>
                    </ng-template>

                    <ng-template ng-option-tmp let-item="item">
                      <div class="dropdown-option">
                        <div class="fw-medium">
                          {{ getItemDisplay(item) }}
                        </div>
                        <small *ngIf="item.adicional" class="text-muted">
                          {{ item.adicional }}
                        </small>
                      </div>
                    </ng-template>

                  </ng-select>
                  <div *ngIf="submitted && f['idFase'].invalid" class="invalid-feedback d-block">
                    Debe seleccionar una fase
                  </div>
                </div>
              </div>

              <!-- Site -->
              <div class="col-md-6">
                <div class="form-group" [class.has-error]="submitted && f['idSite'].invalid">
                  <label class="form-label fw-medium">
                    Site <span class="text-danger">*</span>
                  </label>
                  <ng-select
                    [items]="sites"
                    bindLabel="label"
                    bindValue="id"
                    [placeholder]="'Seleccione site'"
                    [clearable]="true"
                    [searchable]="true"
                    [(ngModel)]="form.value.idSite"
                    [ngModelOptions]="{standalone: true}"
                    (change)="form.get('idSite')?.setValue($event?.id)"
                    [class.is-invalid]="submitted && f['idSite'].invalid">

                    <ng-template ng-label-tmp let-item="item">
                      <span *ngIf="item">
                        {{ getItemDisplay(item) }}
                      </span>
                    </ng-template>

                    <ng-template ng-option-tmp let-item="item">
                      <div class="dropdown-option">
                        <div class="fw-medium">
                          {{ getItemDisplay(item) }}
                        </div>
                        <small *ngIf="item.adicional" class="text-muted">
                          {{ item.adicional }}
                        </small>
                      </div>
                    </ng-template>

                  </ng-select>
                  <div *ngIf="submitted && f['idSite'].invalid" class="invalid-feedback d-block">
                    Debe seleccionar un site
                  </div>
                </div>
              </div>

              <!-- Región -->
              <div class="col-md-6">
                <div class="form-group" [class.has-error]="submitted && f['idRegion'].invalid">
                  <label class="form-label fw-medium">
                    Región <span class="text-danger">*</span>
                  </label>
                  <ng-select
                    [items]="regiones"
                    bindLabel="label"
                    bindValue="id"
                    [placeholder]="'Seleccione región'"
                    [clearable]="true"
                    [searchable]="true"
                    [(ngModel)]="form.value.idRegion"
                    [ngModelOptions]="{standalone: true}"
                    (change)="form.get('idRegion')?.setValue($event?.id)"
                    [class.is-invalid]="submitted && f['idRegion'].invalid">

                    <ng-template ng-label-tmp let-item="item">
                      <span *ngIf="item">
                        {{ getItemDisplay(item) }}
                      </span>
                    </ng-template>

                    <ng-template ng-option-tmp let-item="item">
                      <div class="dropdown-option">
                        <div class="fw-medium">
                          {{ getItemDisplay(item) }}
                        </div>
                        <small *ngIf="item.adicional" class="text-muted">
                          {{ item.adicional }}
                        </small>
                      </div>
                    </ng-template>

                  </ng-select>
                  <div *ngIf="submitted && f['idRegion'].invalid" class="invalid-feedback d-block">
                    Debe seleccionar una región
                  </div>
                </div>
              </div>

              <!-- OT Anterior -->
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label fw-medium">
                    OT Anterior
                    <span class="badge bg-secondary-subtle text-secondary ms-1 fs-7">Opcional</span>
                  </label>
                  <input type="number" class="form-control form-control-lg"
                         formControlName="idOtsAnterior"
                         min="1"
                         placeholder="Número de OT anterior">
                  <small class="form-text text-muted">
                    Número de OT previa si aplica (único campo opcional)
                  </small>
                </div>
              </div>

              <!-- Descripción -->
              <div class="col-12">
                <div class="form-group">
                  <label class="form-label fw-medium">
                    Descripción <span class="text-danger">*</span>
                    <span *ngIf="!isEditMode" class="badge bg-info-subtle text-info ms-1 fs-7">Auto-generada</span>
                  </label>
                  <textarea class="form-control" formControlName="descripcion" rows="3"
                            [readonly]="!isEditMode || isViewMode"
                            [class.bg-light]="!isEditMode || isViewMode"
                            placeholder="Descripción automática según selección..."></textarea>
                  <div *ngIf="submitted && f['descripcion'].invalid" class="invalid-feedback d-block">
                    La descripción es requerida
                  </div>
                  <small *ngIf="!isEditMode" class="form-text text-info">
                    <i class="bi bi-info-circle me-1"></i>
                    La descripción se genera automáticamente según las selecciones realizadas
                  </small>
                </div>
              </div>
            </div>

            <!-- Botones paso 1 -->
            <div class="step-actions mt-5 pt-4 border-top">
              <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-outline-danger btn-lg px-4"
                        (click)="resetForm()" [disabled]="loading || isViewMode">
                  <i class="bi bi-x-circle me-2"></i>
                  {{ isEditMode ? 'Cancelar' : 'Limpiar' }}
                </button>
                <button *ngIf="!isViewMode" type="button" class="btn btn-primary btn-lg px-5"
                        (click)="cambiarPaso(2)"
                        [disabled]="form.invalid || loading">
                  Continuar
                  <i class="bi bi-arrow-right ms-2"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Paso 2: Responsables -->
          <div *ngIf="currentStep === 2" class="step-content animate__animated animate__fadeIn">
            <h5 class="step-title mb-4 pb-2 border-bottom">
              <i class="bi bi-person-badge text-primary me-2"></i>
              Responsables y Contactos
              <span class="badge bg-primary-subtle text-primary ms-2 fs-7">Todos obligatorios</span>
            </h5>

            <div class="alert alert-info border-0 bg-info-subtle mb-4">
              <i class="bi bi-info-circle me-2"></i>
              <strong>Todos los siguientes campos son obligatorios.</strong> Debe asignar todos los responsables para continuar.
            </div>

            <div class="row g-4">
              <!-- Columna Izquierda -->
              <div class="col-md-6">
                <h6 class="text-muted mb-3">
                  <i class="bi bi-building me-2"></i>
                  Cliente Solicitante
                </h6>

                <!-- Jefatura Cliente -->
                <div class="form-group mb-4" [class.has-error]="submitted && f['idJefaturaClienteSolicitante'].invalid">
                  <label class="form-label fw-medium">
                    Jefatura Cliente <span class="text-danger">*</span>
                  </label>
                  <ng-select
                    [items]="jefaturasCliente"
                    bindLabel="label"
                    bindValue="id"
                    [placeholder]="'Seleccione jefatura cliente'"
                    [clearable]="true"
                    [searchable]="true"
                    [(ngModel)]="form.value.idJefaturaClienteSolicitante"
                    [ngModelOptions]="{standalone: true}"
                    (change)="form.get('idJefaturaClienteSolicitante')?.setValue($event?.id)"
                    (search)="onSearchJefaturaCliente($event)"
                    [class.is-invalid]="submitted && f['idJefaturaClienteSolicitante'].invalid">

                    <ng-template ng-label-tmp let-item="item">
                      <span *ngIf="item">
                        {{ getItemDisplay(item) }}
                      </span>
                    </ng-template>

                    <ng-template ng-option-tmp let-item="item">
                      <div class="dropdown-option">
                        <div class="fw-medium">
                          {{ getItemDisplay(item) }}
                        </div>
                        <small *ngIf="item.adicional" class="text-muted">
                          {{ item.adicional }}
                        </small>
                      </div>
                    </ng-template>

                  </ng-select>
                  <div *ngIf="submitted && f['idJefaturaClienteSolicitante'].invalid" class="invalid-feedback d-block">
                    Debe seleccionar una jefatura cliente
                  </div>
                </div>

                <!-- Analista Cliente -->
                <div class="form-group mb-4" [class.has-error]="submitted && f['idAnalistaClienteSolicitante'].invalid">
                  <label class="form-label fw-medium">
                    Analista Cliente <span class="text-danger">*</span>
                  </label>
                  <ng-select
                    [items]="analistasCliente"
                    bindLabel="label"
                    bindValue="id"
                    [placeholder]="'Seleccione analista cliente'"
                    [clearable]="true"
                    [searchable]="true"
                    [(ngModel)]="form.value.idAnalistaClienteSolicitante"
                    [ngModelOptions]="{standalone: true}"
                    (change)="form.get('idAnalistaClienteSolicitante')?.setValue($event?.id)"
                    (search)="onSearchAnalistaCliente($event)"
                    [class.is-invalid]="submitted && f['idAnalistaClienteSolicitante'].invalid">

                    <ng-template ng-label-tmp let-item="item">
                      <span *ngIf="item">
                        {{ getItemDisplay(item) }}
                      </span>
                    </ng-template>

                    <ng-template ng-option-tmp let-item="item">
                      <div class="dropdown-option">
                        <div class="fw-medium">
                          {{ getItemDisplay(item) }}
                        </div>
                        <small *ngIf="item.adicional" class="text-muted">
                          {{ item.adicional }}
                        </small>
                      </div>
                    </ng-template>

                  </ng-select>
                  <div *ngIf="submitted && f['idAnalistaClienteSolicitante'].invalid" class="invalid-feedback d-block">
                    Debe seleccionar un analista cliente
                  </div>
                </div>

                <!-- Coordinador TI/CW -->
                <div class="form-group mb-4" [class.has-error]="submitted && f['idCoordinadorTiCw'].invalid">
                  <label class="form-label fw-medium">
                    Coordinador TI/CW <span class="text-danger">*</span>
                  </label>
                  <ng-select
                    [items]="coordinadoresTiCw"
                    bindLabel="label"
                    bindValue="id"
                    [placeholder]="'Seleccione coordinador TI/CW'"
                    [clearable]="true"
                    [searchable]="true"
                    [(ngModel)]="form.value.idCoordinadorTiCw"
                    [ngModelOptions]="{standalone: true}"
                    (change)="form.get('idCoordinadorTiCw')?.setValue($event?.id)"
                    (search)="onSearchCoordinadorTiCw($event)"
                    [class.is-invalid]="submitted && f['idCoordinadorTiCw'].invalid">

                    <ng-template ng-label-tmp let-item="item">
                      <span *ngIf="item">
                        {{ getItemDisplay(item) }}
                      </span>
                    </ng-template>

                    <ng-template ng-option-tmp let-item="item">
                      <div class="dropdown-option">
                        <div class="fw-medium">
                          {{ getItemDisplay(item) }}
                        </div>
                        <small *ngIf="item.adicional" class="text-muted">
                          {{ item.adicional }}
                        </small>
                      </div>
                    </ng-template>

                  </ng-select>
                  <div *ngIf="submitted && f['idCoordinadorTiCw'].invalid" class="invalid-feedback d-block">
                    Debe seleccionar un coordinador TI/CW
                  </div>
                </div>
              </div>

              <!-- Columna Derecha -->
              <div class="col-md-6">
                <h6 class="text-muted mb-3">
                  <i class="bi bi-person-gear me-2"></i>
                  Responsables Internos
                </h6>

                <!-- Jefatura Responsable -->
                <div class="form-group mb-4" [class.has-error]="submitted && f['idJefaturaResponsable'].invalid">
                  <label class="form-label fw-medium">
                    Jefatura Responsable <span class="text-danger">*</span>
                  </label>
                  <ng-select
                    [items]="jefaturasResponsable"
                    bindLabel="label"
                    bindValue="id"
                    [placeholder]="'Seleccione jefatura responsable'"
                    [clearable]="true"
                    [searchable]="true"
                    [(ngModel)]="form.value.idJefaturaResponsable"
                    [ngModelOptions]="{standalone: true}"
                    (change)="form.get('idJefaturaResponsable')?.setValue($event?.id)"
                    (search)="onSearchJefaturaResponsable($event)"
                    [class.is-invalid]="submitted && f['idJefaturaResponsable'].invalid">

                    <ng-template ng-label-tmp let-item="item">
                      <span *ngIf="item">
                        {{ getItemDisplay(item) }}
                      </span>
                    </ng-template>

                    <ng-template ng-option-tmp let-item="item">
                      <div class="dropdown-option">
                        <div class="fw-medium">
                          {{ getItemDisplay(item) }}
                        </div>
                        <small *ngIf="item.adicional" class="text-muted">
                          {{ item.adicional }}
                        </small>
                      </div>
                    </ng-template>

                  </ng-select>
                  <div *ngIf="submitted && f['idJefaturaResponsable'].invalid" class="invalid-feedback d-block">
                    Debe seleccionar una jefatura responsable
                  </div>
                </div>

                <!-- Liquidador -->
                <div class="form-group mb-4" [class.has-error]="submitted && f['idLiquidador'].invalid">
                  <label class="form-label fw-medium">
                    Liquidador <span class="text-danger">*</span>
                  </label>
                  <ng-select
                    [items]="liquidadores"
                    bindLabel="label"
                    bindValue="id"
                    [placeholder]="'Seleccione liquidador'"
                    [clearable]="true"
                    [searchable]="true"
                    [(ngModel)]="form.value.idLiquidador"
                    [ngModelOptions]="{standalone: true}"
                    (change)="form.get('idLiquidador')?.setValue($event?.id)"
                    (search)="onSearchLiquidador($event)"
                    [class.is-invalid]="submitted && f['idLiquidador'].invalid">

                    <ng-template ng-label-tmp let-item="item">
                      <span *ngIf="item">
                        {{ getItemDisplay(item) }}
                      </span>
                    </ng-template>

                    <ng-template ng-option-tmp let-item="item">
                      <div class="dropdown-option">
                        <div class="fw-medium">
                          {{ getItemDisplay(item) }}
                        </div>
                        <small *ngIf="item.adicional" class="text-muted">
                          {{ item.adicional }}
                        </small>
                      </div>
                    </ng-template>

                  </ng-select>
                  <div *ngIf="submitted && f['idLiquidador'].invalid" class="invalid-feedback d-block">
                    Debe seleccionar un liquidador
                  </div>
                </div>

                <!-- Ejecutante -->
                <div class="form-group mb-4" [class.has-error]="submitted && f['idEjecutante'].invalid">
                  <label class="form-label fw-medium">
                    Ejecutante <span class="text-danger">*</span>
                  </label>
                  <ng-select
                    [items]="ejecutantes"
                    bindLabel="label"
                    bindValue="id"
                    [placeholder]="'Seleccione ejecutante'"
                    [clearable]="true"
                    [searchable]="true"
                    [(ngModel)]="form.value.idEjecutante"
                    [ngModelOptions]="{standalone: true}"
                    (change)="form.get('idEjecutante')?.setValue($event?.id)"
                    (search)="onSearchEjecutante($event)"
                    [class.is-invalid]="submitted && f['idEjecutante'].invalid">

                    <ng-template ng-label-tmp let-item="item">
                      <span *ngIf="item">
                        {{ getItemDisplay(item) }}
                      </span>
                    </ng-template>

                    <ng-template ng-option-tmp let-item="item">
                      <div class="dropdown-option">
                        <div class="fw-medium">
                          {{ getItemDisplay(item) }}
                        </div>
                        <small *ngIf="item.adicional" class="text-muted">
                          {{ item.adicional }}
                        </small>
                      </div>
                    </ng-template>

                  </ng-select>
                  <div *ngIf="submitted && f['idEjecutante'].invalid" class="invalid-feedback d-block">
                    Debe seleccionar un ejecutante
                  </div>
                </div>

                <!-- Analista Contable -->
                <div class="form-group mb-4" [class.has-error]="submitted && f['idAnalistaContable'].invalid">
                  <label class="form-label fw-medium">
                    Analista Contable <span class="text-danger">*</span>
                  </label>
                  <ng-select
                    [items]="analistasContable"
                    bindLabel="label"
                    bindValue="id"
                    [placeholder]="'Seleccione analista contable'"
                    [clearable]="true"
                    [searchable]="true"
                    [(ngModel)]="form.value.idAnalistaContable"
                    [ngModelOptions]="{standalone: true}"
                    (change)="form.get('idAnalistaContable')?.setValue($event?.id)"
                    (search)="onSearchAnalistaContable($event)"
                    [class.is-invalid]="submitted && f['idAnalistaContable'].invalid">

                    <ng-template ng-label-tmp let-item="item">
                      <span *ngIf="item">
                        {{ getItemDisplay(item) }}
                      </span>
                    </ng-template>

                    <ng-template ng-option-tmp let-item="item">
                      <div class="dropdown-option">
                        <div class="fw-medium">
                          {{ getItemDisplay(item) }}
                        </div>
                        <small *ngIf="item.adicional" class="text-muted">
                          {{ item.adicional }}
                        </small>
                      </div>
                    </ng-template>

                  </ng-select>
                  <div *ngIf="submitted && f['idAnalistaContable'].invalid" class="invalid-feedback d-block">
                    Debe seleccionar un analista contable
                  </div>
                </div>

                <!-- ESTADO OT -->
                <div class="form-group mb-4" *ngIf="isEditMode" [class.has-error]="submitted && f['idEstadoOt'].invalid">
                  <label class="form-label fw-medium">
                    Estado OT <span class="text-danger">*</span>
                  </label>
                  <ng-select
                    [items]="estadoOT"
                    bindLabel="label"
                    bindValue="id"
                    [placeholder]="'Seleccione estado OT'"
                    [clearable]="true"
                    [searchable]="true"
                    [(ngModel)]="form.value.idEstadoOt"
                    [ngModelOptions]="{standalone: true}"
                    (change)="form.get('idEstadoOt')?.setValue($event?.id)"
                    (search)="onSearchEstadoOT($event)"
                    [class.is-invalid]="submitted && f['idEstadoOt'].invalid">

                    <ng-template ng-label-tmp let-item="item">
                      <span *ngIf="item">
                        {{ getItemDisplay(item) }}
                      </span>
                    </ng-template>

                    <ng-template ng-option-tmp let-item="item">
                      <div class="dropdown-option">
                        <div class="fw-medium">
                          {{ getItemDisplay(item) }}
                        </div>
                        <small *ngIf="item.adicional" class="text-muted">
                          {{ item.adicional }}
                        </small>
                      </div>
                    </ng-template>

                  </ng-select>
                  <div *ngIf="submitted && f['idEstadoOt'].invalid" class="invalid-feedback d-block">
                    Debe seleccionar un estado OT
                  </div>
                </div>
              </div>
            </div>

            <!-- Botones paso 2 -->
            <div class="step-actions mt-5 pt-4 border-top">
              <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-outline-secondary btn-lg px-4"
                        (click)="cambiarPaso(1)">
                  <i class="bi bi-arrow-left me-2"></i>
                  Regresar
                </button>
                <button *ngIf="!isViewMode" type="button" class="btn btn-primary btn-lg px-5"
                        (click)="cambiarPaso(3)">
                  Continuar
                  <i class="bi bi-arrow-right ms-2"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Paso 3: Confirmar -->
          <div *ngIf="currentStep === 3" class="step-content animate__animated animate__fadeIn">
            <h5 class="step-title mb-4 pb-2 border-bottom">
              <i class="bi bi-clipboard-check text-primary me-2"></i>
              Confirmación de Datos
            </h5>

            <div class="alert alert-success border-0 bg-success-subtle mb-5">
              <div class="d-flex align-items-center">
                <i class="bi bi-check-circle-fill text-success fs-4 me-3"></i>
                <div>
                  <h6 class="alert-heading mb-1">¡Revisión final!</h6>
                  <p class="mb-0">Verifique que toda la información sea correcta antes de guardar.</p>
                </div>
              </div>
            </div>

            <!-- Resumen en tarjetas -->
            <div class="row g-4 mb-5">
              <!-- Información Principal -->
              <div class="col-lg-8">
                <div class="card border-0 shadow-sm h-100">
                  <div class="card-header bg-white border-bottom">
                    <h6 class="mb-0 fw-bold text-primary">
                      <i class="bi bi-card-checklist me-2"></i>
                      Información Principal
                    </h6>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-3">
                          <small class="text-muted d-block mb-1">Cliente</small>
                          <p class="fw-medium mb-0">{{ clienteNombre || '—' }}</p>
                        </div>
                        <div class="mb-3">
                          <small class="text-muted d-block mb-1">Área</small>
                          <p class="fw-medium mb-0">{{ areaNombre || '—' }}</p>
                        </div>
                        <div class="mb-3">
                          <small class="text-muted d-block mb-1">Proyecto</small>
                          <p class="fw-medium mb-0">{{ proyectoNombre || '—' }}</p>
                        </div>
                        <div class="mb-3">
                          <small class="text-muted d-block mb-1">Fase</small>
                          <p class="fw-medium mb-0">{{ faseNombre || '—' }}</p>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <small class="text-muted d-block mb-1">Site</small>
                          <p class="fw-medium mb-0">{{ siteNombre || '—' }}</p>
                        </div>
                        <div class="mb-3">
                          <small class="text-muted d-block mb-1">Región</small>
                          <p class="fw-medium mb-0">{{ regionNombre || '—' }}</p>
                        </div>
                        <div class="mb-3">
                          <small class="text-muted d-block mb-1">Fecha Apertura</small>
                          <p class="fw-medium mb-0">{{ fechaAperturaFormatted || '—' }}</p>
                        </div>
                        <div class="mb-3">
                          <small class="text-muted d-block mb-1">OT Anterior</small>
                          <p class="fw-medium mb-0">{{ form.value.idOtsAnterior || 'No especificada (opcional)' }}</p>
                        </div>
                      </div>
                    </div>

                    <div class="mt-4">
                      <small class="text-muted d-block mb-1">Descripción</small>
                      <div class="bg-light p-3 rounded border">
                        <p class="mb-0 text-muted">{{ form.value.descripcion || 'Descripción automática' }}</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Responsables -->
              <div class="col-lg-4">
                <div class="card border-0 shadow-sm h-100">
                  <div class="card-header bg-white border-bottom">
                    <h6 class="mb-0 fw-bold text-primary">
                      <i class="bi bi-people me-2"></i>
                      Responsables
                    </h6>
                  </div>
                  <div class="card-body">
                    <div class="mb-3">
                      <small class="text-muted d-block mb-1">Jefatura Cliente</small>
                      <p class="fw-medium mb-0 small">
                        {{ getResponsableNombre('jefaturaCliente') || '—' }}
                      </p>
                    </div>
                    <div class="mb-3">
                      <small class="text-muted d-block mb-1">Analista Cliente</small>
                      <p class="fw-medium mb-0 small">
                        {{ getResponsableNombre('analistaCliente') || '—' }}
                      </p>
                    </div>
                    <div class="mb-3">
                      <small class="text-muted d-block mb-1">Coordinador</small>
                      <p class="fw-medium mb-0 small">
                        {{ getResponsableNombre('coordinadorTiCw') || '—' }}
                      </p>
                    </div>
                    <div class="mb-3">
                      <small class="text-muted d-block mb-1">Jefatura Responsable</small>
                      <p class="fw-medium mb-0 small">
                        {{ getResponsableNombre('jefaturaResponsable') || '—' }}
                      </p>
                    </div>
                    <div class="mb-3">
                      <small class="text-muted d-block mb-1">Liquidador</small>
                      <p class="fw-medium mb-0 small">
                        {{ getResponsableNombre('liquidador') || '—' }}
                      </p>
                    </div>
                    <div class="mb-3">
                      <small class="text-muted d-block mb-1">Ejecutante</small>
                      <p class="fw-medium mb-0 small">
                        {{ getResponsableNombre('ejecutante') || '—' }}
                      </p>
                    </div>
                    <div class="mb-3">
                      <small class="text-muted d-block mb-1">Analista Contable</small>
                      <p class="fw-medium mb-0 small">
                        {{ getResponsableNombre('analistaContable') || '—' }}
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Botones finales -->
            <div class="step-actions mt-5 pt-4 border-top">
              <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-outline-secondary btn-lg px-4"
                        (click)="cambiarPaso(2)">
                  <i class="bi bi-arrow-left me-2"></i>
                  Regresar
                </button>

                <div class="d-flex gap-3">
                  <button type="button" class="btn btn-outline-danger btn-lg px-4"
                          (click)="onCancel()">
                    Cancelar
                  </button>
                  <button *ngIf="!isViewMode" type="submit" class="btn btn-success btn-lg px-5 shadow-sm"
                          [disabled]="loading || form.invalid">
                    <ng-container *ngIf="!loading">
                      <i class="bi me-2" [ngClass]="isEditMode ? 'bi-save' : 'bi-plus-circle'"></i>
                      {{ isEditMode ? 'Guardar Cambios' : 'Crear OT' }}
                    </ng-container>
                    <ng-container *ngIf="loading">
                      <span class="spinner-border spinner-border-sm me-2"></span>
                      {{ isEditMode ? 'Guardando...' : 'Creando...' }}
                    </ng-container>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Footer -->
    <div class="form-footer bg-light border-top p-3 text-center text-muted small">
      <i class="bi bi-shield-lock me-1"></i>
      <span class="text-danger">*</span> Todos los campos son obligatorios •
      Único campo opcional: OT Anterior
    </div>
  </ng-container>
</div>
