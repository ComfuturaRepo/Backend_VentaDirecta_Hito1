<div class="form-ots-container">
  <!-- Loading Overlay -->
  <div *ngIf="loading" class="loading-overlay">
    <div class="spinner"></div>
    <p>Cargando formulario...</p>
  </div>

  <!-- Formulario Principal -->
  <div *ngIf="!loading" class="form-content">
    <!-- Header -->
    <div class="form-header">
      <h2>
        <i class="bi bi-clipboard-data"></i>
        {{ isEditMode ? 'Editar OT' : 'Nueva OT' }}
        <span *ngIf="isEditMode && form.value.idOts" class="ot-number">
          #{{ form.value.idOts }}
        </span>
      </h2>
      <p class="user-info">
        <i class="bi bi-person"></i> {{ usernameLogueado }}
      </p>
      <button class="close-btn" (click)="onCancel()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <!-- Pasos -->
    <div class="steps">
      <div class="step" [class.active]="currentStep === 1" [class.completed]="currentStep > 1">
        <span class="step-number">1</span>
        <span class="step-label">Información</span>
      </div>
      <div class="step-connector"></div>
      <div class="step" [class.active]="currentStep === 2" [class.completed]="currentStep > 2">
        <span class="step-number">2</span>
        <span class="step-label">Responsables</span>
      </div>
      <div class="step-connector"></div>
      <div class="step" [class.active]="currentStep === 3">
        <span class="step-number">3</span>
        <span class="step-label">Confirmar</span>
      </div>
    </div>

    <!-- Formulario -->
    <form [formGroup]="form" (ngSubmit)="onSubmit()" #formElement>
      <!-- Paso 1: Información Principal -->
      <div *ngIf="currentStep === 1" class="step-content">
        <h3>Información Principal</h3>
        
        <div class="form-grid">
          <!-- Cliente -->
          <div class="form-group">
            <label>Cliente <span class="required">*</span></label>
            <app-ngselect-dropdown
              [items]="clientes"
              [placeholder]="'Seleccione cliente'"
              [loading]="loadingClientes"
              [isInvalid]="submitted && f['idCliente'].invalid"
              [required]="true"
              (selectionChange)="onClienteChange($event)">
            </app-ngselect-dropdown>
            <div *ngIf="submitted && f['idCliente'].invalid" class="error-message">
              Debe seleccionar un cliente
            </div>
          </div>

          <!-- Área -->
          <div class="form-group">
            <label>Área <span class="required">*</span></label>
            <app-ngselect-dropdown
              [items]="areas"
              [placeholder]="selectedClienteId ? 'Seleccione área' : 'Primero seleccione cliente'"
              [loading]="loadingAreas"
              [isInvalid]="submitted && f['idArea'].invalid"
              [required]="true"
              [disabled]="!selectedClienteId"
              (selectionChange)="onAreaChange($event)">
            </app-ngselect-dropdown>
            <div *ngIf="submitted && f['idArea'].invalid" class="error-message">
              Debe seleccionar un área
            </div>
          </div>

          <!-- Proyecto -->
          <div class="form-group">
            <label>Proyecto <span class="required">*</span></label>
            <app-ngselect-dropdown
              [items]="proyectos"
              [placeholder]="'Seleccione proyecto'"
              [loading]="loadingProyectos"
              [isInvalid]="submitted && f['idProyecto'].invalid"
              [required]="true"
              (selectionChange)="onProyectoChange($event)">
            </app-ngselect-dropdown>
            <div *ngIf="submitted && f['idProyecto'].invalid" class="error-message">
              Debe seleccionar un proyecto
            </div>
          </div>

          <!-- Fase -->
          <div class="form-group">
            <label>Fase <span class="required">*</span></label>
            <app-ngselect-dropdown
              [items]="fases"
              [placeholder]="'Seleccione fase'"
              [loading]="loadingFases"
              [isInvalid]="submitted && f['idFase'].invalid"
              [required]="true"
              (selectionChange)="onFaseChange($event)">
            </app-ngselect-dropdown>
            <div *ngIf="submitted && f['idFase'].invalid" class="error-message">
              Debe seleccionar una fase
            </div>
          </div>

          <!-- Site -->
          <div class="form-group">
            <label>Site <span class="required">*</span></label>
            <app-ngselect-dropdown
              [items]="sites"
              [placeholder]="'Seleccione site'"
              [loading]="loadingSites"
              [isInvalid]="submitted && f['idSite'].invalid"
              [required]="true"
              (selectionChange)="onSiteChange($event)">
            </app-ngselect-dropdown>
            <div *ngIf="submitted && f['idSite'].invalid" class="error-message">
              Debe seleccionar un site
            </div>
          </div>

          <!-- Región -->
          <div class="form-group">
            <label>Región <span class="required">*</span></label>
            <app-ngselect-dropdown
              [items]="regiones"
              [placeholder]="'Seleccione región'"
              [loading]="loadingRegiones"
              [isInvalid]="submitted && f['idRegion'].invalid"
              [required]="true"
              (selectionChange)="onRegionChange($event)">
            </app-ngselect-dropdown>
            <div *ngIf="submitted && f['idRegion'].invalid" class="error-message">
              Debe seleccionar una región
            </div>
          </div>

          <!-- Fecha Apertura -->
          <div class="form-group">
            <label>Fecha Apertura <span class="required">*</span></label>
            <input type="date" class="form-control" formControlName="fechaApertura"
                   [class.is-invalid]="submitted && f['fechaApertura'].invalid">
            <div *ngIf="submitted && f['fechaApertura'].invalid" class="error-message">
              La fecha es requerida
            </div>
          </div>

          <!-- OT Anterior -->
          <div class="form-group">
            <label>OT Anterior <span class="optional">(Opcional)</span></label>
            <input type="number" class="form-control" formControlName="idOtsAnterior" min="1">
          </div>
        </div>

        <!-- Descripción -->
        <div class="form-group">
          <label>Descripción <span class="required">*</span></label>
          <textarea class="form-control" formControlName="descripcion" rows="3"
                    [readonly]="!isEditMode || isViewMode"
                    placeholder="Descripción automática según selección..."></textarea>
          <div *ngIf="submitted && f['descripcion'].invalid" class="error-message">
            La descripción es requerida (mínimo 10 caracteres)
          </div>
          <div *ngIf="!isEditMode" class="info-message">
            <i class="bi bi-info-circle"></i> La descripción se genera automáticamente
          </div>
        </div>

        <!-- Resumen Preliminar -->
        <div *ngIf="!isEditMode" class="preview">
          <h4>Vista Preliminar</h4>
          <div class="preview-grid">
            <div><strong>Cliente:</strong> {{ clienteNombre || '—' }}</div>
            <div><strong>Área:</strong> {{ areaNombre || '—' }}</div>
            <div><strong>Proyecto:</strong> {{ proyectoNombre || '—' }}</div>
            <div><strong>Site:</strong> {{ siteNombre || '—' }}</div>
            <div><strong>Región:</strong> {{ regionNombre || '—' }}</div>
            <div><strong>Fecha:</strong> {{ fechaAperturaFormatted || '—' }}</div>
          </div>
        </div>

        <!-- Botones Paso 1 -->
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="resetForm()" [disabled]="isViewMode">
            {{ isEditMode ? 'Cancelar Cambios' : 'Limpiar Todo' }}
          </button>
          <div>
            <button type="button" class="btn btn-outline" (click)="onCancel()">
              Cancelar
            </button>
            <button type="button" class="btn btn-primary" (click)="cambiarPaso(2)" [disabled]="isViewMode">
              Continuar <i class="bi bi-arrow-right"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Paso 2: Responsables -->
      <div *ngIf="currentStep === 2" class="step-content">
        <h3>Responsables y Contactos</h3>
        
        <div class="responsables-grid">
          <!-- Columna Izquierda -->
          <div class="responsables-column">
            <h4><i class="bi bi-building"></i> Cliente Solicitante</h4>
            
            <!-- Jefatura Cliente -->
            <div class="form-group">
              <label>Jefatura Cliente <span class="required">*</span></label>
              <app-ngselect-dropdown
                [items]="jefaturasCliente"
                [placeholder]="'Seleccione jefatura cliente'"
                [loading]="loadingJefaturasCliente"
                [isInvalid]="submitted && f['idJefaturaClienteSolicitante'].invalid"
                [required]="true"
                (selectionChange)="onJefaturaClienteChange($event)"
                (searchChange)="onSearchJefaturaCliente($event)">
              </app-ngselect-dropdown>
              <div *ngIf="submitted && f['idJefaturaClienteSolicitante'].invalid" class="error-message">
                Debe seleccionar una jefatura cliente
              </div>
            </div>

            <!-- Analista Cliente -->
            <div class="form-group">
              <label>Analista Cliente <span class="required">*</span></label>
              <app-ngselect-dropdown
                [items]="analistasCliente"
                [placeholder]="'Seleccione analista cliente'"
                [loading]="loadingAnalistasCliente"
                [isInvalid]="submitted && f['idAnalistaClienteSolicitante'].invalid"
                [required]="true"
                (selectionChange)="onAnalistaClienteChange($event)"
                (searchChange)="onSearchAnalistaCliente($event)">
              </app-ngselect-dropdown>
              <div *ngIf="submitted && f['idAnalistaClienteSolicitante'].invalid" class="error-message">
                Debe seleccionar un analista cliente
              </div>
            </div>

            <!-- Coordinador TI/CW -->
            <div class="form-group">
              <label>Coordinador TI/CW <span class="required">*</span></label>
              <app-ngselect-dropdown
                [items]="coordinadoresTiCw"
                [placeholder]="'Seleccione coordinador TI/CW'"
                [loading]="loadingCoordinadoresTiCw"
                [isInvalid]="submitted && f['idCoordinadorTiCw'].invalid"
                [required]="true"
                (selectionChange)="onCoordinadorTiCwChange($event)"
                (searchChange)="onSearchCoordinadorTiCw($event)">
              </app-ngselect-dropdown>
              <div *ngIf="submitted && f['idCoordinadorTiCw'].invalid" class="error-message">
                Debe seleccionar un coordinador TI/CW
              </div>
            </div>
          </div>

          <!-- Columna Derecha -->
          <div class="responsables-column">
            <h4><i class="bi bi-gear"></i> Responsables Internos</h4>
            
            <!-- Jefatura Responsable -->
            <div class="form-group">
              <label>Jefatura Responsable <span class="required">*</span></label>
              <app-ngselect-dropdown
                [items]="jefaturasResponsable"
                [placeholder]="'Seleccione jefatura responsable'"
                [loading]="loadingJefaturasResponsable"
                [isInvalid]="submitted && f['idJefaturaResponsable'].invalid"
                [required]="true"
                (selectionChange)="onJefaturaResponsableChange($event)"
                (searchChange)="onSearchJefaturaResponsable($event)">
              </app-ngselect-dropdown>
              <div *ngIf="submitted && f['idJefaturaResponsable'].invalid" class="error-message">
                Debe seleccionar una jefatura responsable
              </div>
            </div>

            <!-- Liquidador -->
            <div class="form-group">
              <label>Liquidador <span class="required">*</span></label>
              <app-ngselect-dropdown
                [items]="liquidadores"
                [placeholder]="'Seleccione liquidador'"
                [loading]="loadingLiquidadores"
                [isInvalid]="submitted && f['idLiquidador'].invalid"
                [required]="true"
                (selectionChange)="onLiquidadorChange($event)"
                (searchChange)="onSearchLiquidador($event)">
              </app-ngselect-dropdown>
              <div *ngIf="submitted && f['idLiquidador'].invalid" class="error-message">
                Debe seleccionar un liquidador
              </div>
            </div>

            <!-- Ejecutante -->
            <div class="form-group">
              <label>Ejecutante <span class="required">*</span></label>
              <app-ngselect-dropdown
                [items]="ejecutantes"
                [placeholder]="'Seleccione ejecutante'"
                [loading]="loadingEjecutantes"
                [isInvalid]="submitted && f['idEjecutante'].invalid"
                [required]="true"
                (selectionChange)="onEjecutanteChange($event)"
                (searchChange)="onSearchEjecutante($event)">
              </app-ngselect-dropdown>
              <div *ngIf="submitted && f['idEjecutante'].invalid" class="error-message">
                Debe seleccionar un ejecutante
              </div>
            </div>

            <!-- Analista Contable -->
            <div class="form-group">
              <label>Analista Contable <span class="required">*</span></label>
              <app-ngselect-dropdown
                [items]="analistasContable"
                [placeholder]="'Seleccione analista contable'"
                [loading]="loadingAnalistasContable"
                [isInvalid]="submitted && f['idAnalistaContable'].invalid"
                [required]="true"
                (selectionChange)="onAnalistaContableChange($event)"
                (searchChange)="onSearchAnalistaContable($event)">
              </app-ngselect-dropdown>
              <div *ngIf="submitted && f['idAnalistaContable'].invalid" class="error-message">
                Debe seleccionar un analista contable
              </div>
            </div>

            <!-- Estado OT (solo edición) -->
            <div *ngIf="isEditMode" class="form-group">
              <label>Estado OT <span class="required">*</span></label>
              <app-ngselect-dropdown
                [items]="estadoOT"
                [placeholder]="'Seleccione estado OT'"
                [loading]="loadingEstadoOT"
                [isInvalid]="submitted && f['idEstadoOt'].invalid"
                [required]="true"
                (selectionChange)="onEstadoOTChange($event)"
                (searchChange)="onSearchEstadoOT($event)">
              </app-ngselect-dropdown>
              <div *ngIf="submitted && f['idEstadoOt'].invalid" class="error-message">
                Debe seleccionar un estado OT
              </div>
            </div>
          </div>
        </div>

        <!-- Botones Paso 2 -->
        <div class="form-actions">
          <button type="button" class="btn btn-outline" (click)="cambiarPaso(1)">
            <i class="bi bi-arrow-left"></i> Volver
          </button>
          <div>
            <button type="button" class="btn btn-secondary" (click)="resetForm()" [disabled]="isViewMode">
              Reiniciar
            </button>
            <button type="button" class="btn btn-primary" (click)="cambiarPaso(3)" [disabled]="isViewMode">
              Continuar <i class="bi bi-arrow-right"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Paso 3: Confirmar -->
      <div *ngIf="currentStep === 3" class="step-content">
        <h3>Confirmar y Guardar</h3>
        
        <div class="alert alert-success">
          <i class="bi bi-check-circle"></i>
          <div>
            <h5>¡Revisión final!</h5>
            <p>Verifique que toda la información sea correcta antes de proceder.</p>
          </div>
        </div>

        <!-- Resumen -->
        <div class="summary-grid">
          <!-- Información Principal -->
          <div class="summary-column">
            <h4><i class="bi bi-card-checklist"></i> Información Principal</h4>
            <div class="summary-item">
              <strong>Cliente:</strong> {{ clienteNombre || '—' }}
            </div>
            <div class="summary-item">
              <strong>Área:</strong> {{ areaNombre || '—' }}
            </div>
            <div class="summary-item">
              <strong>Proyecto:</strong> {{ proyectoNombre || '—' }}
            </div>
            <div class="summary-item">
              <strong>Fase:</strong> {{ faseNombre || '—' }}
            </div>
            <div class="summary-item">
              <strong>Site:</strong> {{ siteNombre || '—' }}
            </div>
            <div class="summary-item">
              <strong>Región:</strong> {{ regionNombre || '—' }}
            </div>
            <div class="summary-item">
              <strong>Fecha Apertura:</strong> {{ fechaAperturaFormatted || '—' }}
            </div>
            <div class="summary-item">
              <strong>OT Anterior:</strong> {{ form.value.idOtsAnterior || 'No especificada' }}
            </div>
            
            <div class="summary-item descripcion">
              <strong>Descripción:</strong>
              <p>{{ form.value.descripcion || 'Descripción automática' }}</p>
            </div>
          </div>

          <!-- Responsables -->
          <div class="summary-column">
            <h4><i class="bi bi-people"></i> Responsables</h4>
            <div class="summary-item">
              <strong>Jefatura Cliente:</strong> {{ getItemNombre(selectedJefaturaClienteId, jefaturasCliente) || '—' }}
            </div>
            <div class="summary-item">
              <strong>Analista Cliente:</strong> {{ getItemNombre(selectedAnalistaClienteId, analistasCliente) || '—' }}
            </div>
            <div class="summary-item">
              <strong>Coordinador TI/CW:</strong> {{ getItemNombre(selectedCoordinadorTiCwId, coordinadoresTiCw) || '—' }}
            </div>
            <div class="summary-item">
              <strong>Jefatura Responsable:</strong> {{ getItemNombre(selectedJefaturaResponsableId, jefaturasResponsable) || '—' }}
            </div>
            <div class="summary-item">
              <strong>Liquidador:</strong> {{ getItemNombre(selectedLiquidadorId, liquidadores) || '—' }}
            </div>
            <div class="summary-item">
              <strong>Ejecutante:</strong> {{ getItemNombre(selectedEjecutanteId, ejecutantes) || '—' }}
            </div>
            <div class="summary-item">
              <strong>Analista Contable:</strong> {{ getItemNombre(selectedAnalistaContableId, analistasContable) || '—' }}
            </div>
            <div *ngIf="isEditMode" class="summary-item">
              <strong>Estado OT:</strong> {{ getItemNombre(selectedEstadoOTId, estadoOT) || '—' }}
            </div>
          </div>
        </div>

        <!-- Botones Finales -->
        <div class="form-actions">
          <button type="button" class="btn btn-outline" (click)="cambiarPaso(2)">
            <i class="bi bi-arrow-left"></i> Volver
          </button>
          <div>
            <button type="button" class="btn btn-outline-danger" (click)="onCancel()">
              Cancelar
            </button>
            <button type="submit" class="btn btn-success" [disabled]="loading || !form.valid || isViewMode">
              <span *ngIf="!loading">
                <i class="bi" [ngClass]="isEditMode ? 'bi-save' : 'bi-plus-circle'"></i>
                {{ isEditMode ? 'Guardar Cambios' : 'Crear OT' }}
              </span>
              <span *ngIf="loading" class="spinner"></span>
            </button>
          </div>
        </div>
      </div>
    </form>

    <!-- Footer -->
    <div class="form-footer">
      <div class="footer-info">
        <span class="required-info"><span class="required">*</span> Campos obligatorios</span>
        <span class="step-info">Paso {{ currentStep }} de 3</span>
      </div>
    </div>
  </div>
</div>