<div class="form-ots-container">
  <!-- Loading Overlay -->
  <div *ngIf="loading" class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-white bg-opacity-90 z-3">
    <div class="text-center">
      <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="mt-3 text-primary fw-semibold">Cargando formulario...</p>
    </div>
  </div>

  <!-- Formulario Principal - Optimizado para modal -->
  <div *ngIf="!loading" class="form-main-wrapper d-flex flex-column h-100">
    <!-- Header Fijo -->
    <div class="form-header bg-white shadow-sm">
      <div class="container-fluid py-3 px-4 bg-primary text-white">
        <div class="d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-3">
            <div class="bg-white bg-opacity-20 rounded-3 p-2">
              <i class="bi bi-clipboard-data text-white fs-4"></i>
            </div>
            <div>
              <h1 class="h4 mb-1 fw-bold text-white">
                {{ isEditMode ? 'Editar Orden de Trabajo' : 'Nueva Orden de Trabajo' }}
                <span *ngIf="isEditMode && form.value.idOts" class="badge bg-white text-primary ms-2">
                  #{{ form.value.idOts }}
                </span>
              </h1>
              <div class="d-flex gap-3 align-items-center text-white text-opacity-85">
                <span><i class="bi bi-person me-1"></i> {{ usernameLogueado }}</span>
                <span class="badge" [ngClass]="isEditMode ? 'bg-warning' : 'bg-success'">
                  {{ isEditMode ? 'Modo Edición' : 'Modo Creación' }}
                </span>
              </div>
            </div>
          </div>
          <button class="btn btn-light btn-sm rounded-circle" (click)="onCancel()">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
      </div>

      <!-- Pasos -->
      <div class="container-fluid py-2 px-4 bg-white border-bottom">
        <div class="row align-items-center">
          <div class="col-12">
            <div class="d-flex justify-content-center align-items-center">
              <!-- Paso 1 -->
              <div class="text-center">
                <div class="step-circle mb-2" [class.active]="currentStep === 1" [class.completed]="currentStep > 1">
                  <span class="step-number">1</span>
                  <i class="bi bi-check step-check" *ngIf="currentStep > 1"></i>
                </div>
                <div class="step-label">Información</div>
              </div>

              <div class="step-line mx-3" [class.completed]="currentStep > 1"></div>

              <!-- Paso 2 -->
              <div class="text-center">
                <div class="step-circle mb-2" [class.active]="currentStep === 2" [class.completed]="currentStep > 2">
                  <span class="step-number">2</span>
                  <i class="bi bi-check step-check" *ngIf="currentStep > 2"></i>
                </div>
                <div class="step-label">Responsables</div>
              </div>

              <div class="step-line mx-3" [class.completed]="currentStep > 2"></div>

              <!-- Paso 3 -->
              <div class="text-center">
                <div class="step-circle mb-2" [class.active]="currentStep === 3">
                  <span class="step-number">3</span>
                </div>
                <div class="step-label">Confirmar</div>
              </div>
            </div>

            <!-- Progress Bar Compacta -->
            <div class="mt-3">
              <div class="d-flex justify-content-between mb-1 small">
                <small>Progreso</small>
                <small class="fw-semibold">{{ (currentStep / 3) * 100 | number:'1.0-0' }}%</small>
              </div>
              <div class="progress" style="height: 4px;">
                <div class="progress-bar" [style.width.%]="(currentStep / 3) * 100"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Contenido con Scroll Flexible -->
    <div class="form-content-wrapper flex-grow-1 d-flex flex-column">
      <div class="form-content-scroll flex-grow-1">
        <div class="container py-3 px-3 px-md-4">
          <form [formGroup]="form" (ngSubmit)="onSubmit()">

            <!-- Paso 1: Información Principal -->
            <div *ngIf="currentStep === 1" class="animate__animated animate__fadeIn">
              <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-white border-0 py-2 px-3">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h3 class="h6 mb-1 text-primary fw-bold">
                        <i class="bi bi-info-circle me-2"></i>
                        Información Principal
                      </h3>
                      <p class="text-muted mb-0 small">Complete los datos básicos de la orden de trabajo</p>
                    </div>
                    <span class="badge bg-primary bg-opacity-10 text-primary small">Paso 1 de 3</span>
                  </div>
                </div>

                <div class="card-body px-3 py-3">
                  <div class="row g-2">
                    <!-- Cliente -->
                    <div class="col-md-6">
                      <label class="form-label fw-semibold small">
                        <i class="bi bi-building me-1"></i> Cliente <span class="text-danger">*</span>
                      </label>
                      <app-ngselect-dropdown
                        [items]="clientes"
                        [placeholder]="'Seleccione un cliente'"
                        [loading]="loading"
                        [isInvalid]="submitted && f['idCliente'].invalid"
                        [required]="true"
                        (selectionChange)="onClienteChange($event)">
                      </app-ngselect-dropdown>
                      <div *ngIf="submitted && f['idCliente'].invalid" class="text-danger small mt-1">
                        <i class="bi bi-exclamation-triangle me-1"></i> Campo obligatorio
                      </div>
                    </div>

                    <!-- Área -->
                    <div class="col-md-6">
                      <label class="form-label fw-semibold small">
                        <i class="bi bi-diagram-3 me-1"></i> Área <span class="text-danger">*</span>
                      </label>
                      <app-ngselect-dropdown
                        [items]="areas"
                        [placeholder]="selectedClienteId ? 'Seleccione un área' : 'Primero seleccione un cliente'"
                        [loading]="loading"
                        [isInvalid]="submitted && f['idArea'].invalid"
                        [required]="true"
                        [disabled]="!selectedClienteId"
                        (selectionChange)="onAreaChange($event)">
                      </app-ngselect-dropdown>
                      <div *ngIf="submitted && f['idArea'].invalid" class="text-danger small mt-1">
                        <i class="bi bi-exclamation-triangle me-1"></i> Campo obligatorio
                      </div>
                    </div>

                    <!-- Proyecto -->
                    <div class="col-md-6">
                      <label class="form-label fw-semibold small">
                        <i class="bi bi-kanban me-1"></i> Proyecto <span class="text-danger">*</span>
                      </label>
                      <app-ngselect-dropdown
                        [items]="proyectos"
                        [placeholder]="'Seleccione un proyecto'"
                        [loading]="loading"
                        [isInvalid]="submitted && f['idProyecto'].invalid"
                        [required]="true"
                        (selectionChange)="onProyectoChange($event)">
                      </app-ngselect-dropdown>
                      <div *ngIf="submitted && f['idProyecto'].invalid" class="text-danger small mt-1">
                        <i class="bi bi-exclamation-triangle me-1"></i> Campo obligatorio
                      </div>
                    </div>

                    <!-- Fase -->
                    <div class="col-md-6">
                      <label class="form-label fw-semibold small">
                        <i class="bi bi-puzzle me-1"></i> Fase <span class="text-danger">*</span>
                      </label>
                      <app-ngselect-dropdown
                        [items]="fases"
                        [placeholder]="'Seleccione una fase'"
                        [loading]="loading"
                        [isInvalid]="submitted && f['idFase'].invalid"
                        [required]="true"
                        (selectionChange)="onFaseChange($event)">
                      </app-ngselect-dropdown>
                      <div *ngIf="submitted && f['idFase'].invalid" class="text-danger small mt-1">
                        <i class="bi bi-exclamation-triangle me-1"></i> Campo obligatorio
                      </div>
                    </div>

                    <!-- Site -->
                    <div class="col-md-6">
                      <label class="form-label fw-semibold small">
                        <i class="bi bi-geo-alt me-1"></i> Site <span class="text-danger">*</span>
                      </label>
                      <app-ngselect-dropdown
                        [items]="sites"
                        [placeholder]="'Seleccione un site'"
                        [loading]="loading"
                        [isInvalid]="submitted && f['idSite'].invalid"
                        [required]="true"
                        (selectionChange)="onSiteChange($event)">
                      </app-ngselect-dropdown>
                      <div *ngIf="submitted && f['idSite'].invalid" class="text-danger small mt-1">
                        <i class="bi bi-exclamation-triangle me-1"></i> Campo obligatorio
                      </div>
                    </div>

                    <!-- Tipo OT -->
                    <div class="col-md-6">
                      <label class="form-label fw-semibold small">
                        <i class="bi bi-tag me-1"></i> Tipo OT <span class="text-danger">*</span>
                      </label>
                      <app-ngselect-dropdown
                        [items]="tiposOt"
                        [placeholder]="'Seleccione tipo OT'"
                        [loading]="loading"
                        [isInvalid]="submitted && f['idTipoOt'].invalid"
                        [required]="true"
                        (selectionChange)="onTipoOtChange($event)">
                      </app-ngselect-dropdown>
                    </div>

                    <!-- Región -->
                    <div class="col-md-6">
                      <label class="form-label fw-semibold small">
                        <i class="bi bi-globe-americas me-1"></i> Región <span class="text-danger">*</span>
                      </label>
                      <app-ngselect-dropdown
                        [items]="regiones"
                        [placeholder]="'Seleccione una región'"
                        [loading]="loading"
                        [isInvalid]="submitted && f['idRegion'].invalid"
                        [required]="true"
                        (selectionChange)="onRegionChange($event)">
                      </app-ngselect-dropdown>
                      <div *ngIf="submitted && f['idRegion'].invalid" class="text-danger small mt-1">
                        <i class="bi bi-exclamation-triangle me-1"></i> Campo obligatorio
                      </div>
                    </div>

                    <!-- Fecha Apertura -->
                    <div class="col-md-6">
                      <label class="form-label fw-semibold small">
                        <i class="bi bi-calendar-date me-1"></i> Fecha Apertura <span class="text-danger">*</span>
                      </label>
                      <div class="input-group input-group-sm">
                        <span class="input-group-text py-2"><i class="bi bi-calendar"></i></span>
                        <input type="date" class="form-control py-2" formControlName="fechaApertura"
                               [class.is-invalid]="submitted && f['fechaApertura'].invalid">
                      </div>
                      <div *ngIf="submitted && f['fechaApertura'].invalid" class="text-danger small mt-1">
                        <i class="bi bi-exclamation-triangle me-1"></i> Campo obligatorio
                      </div>
                    </div>

                    <!-- OT Anterior (Condicional) -->
                    <div class="col-md-6">
                      <label class="form-label fw-semibold small">
                        <i class="bi bi-link-45deg me-1"></i> OT Anterior
                        <span *ngIf="esOtAnteriorRequerido" class="text-danger">*</span>
                        <span *ngIf="!esOtAnteriorRequerido" class="text-muted small">(Opcional)</span>
                      </label>
                      <div class="input-group input-group-sm">
                        <span class="input-group-text py-2"><i class="bi bi-arrow-left-right"></i></span>
                        <input type="number"
                               class="form-control py-2"
                               formControlName="idOtsAnterior"
                               min="1"
                               max="2147483647"
                               placeholder="Número de OT anterior"
                               [class.is-invalid]="submitted && f['idOtsAnterior'].invalid"
                               [class.input-cerca-limite]="form.value.idOtsAnterior > 1000000000"
                               [class.input-excede-limite]="form.value.idOtsAnterior > 2147483647"
                               (input)="validarNumeroOtAnterior($event)">
                      </div>

                      <div class="d-flex justify-content-between mt-1">
                        <div *ngIf="submitted && f['idOtsAnterior'].invalid" class="text-danger small">
                          <i class="bi bi-exclamation-triangle me-1"></i>
                          <span *ngIf="f['idOtsAnterior'].errors?.['required']">
                            Campo obligatorio para fechas del año anterior
                          </span>
                          <span *ngIf="f['idOtsAnterior'].errors?.['min']">
                            El valor mínimo es 1
                          </span>
                          <span *ngIf="f['idOtsAnterior'].errors?.['max']">
                            El valor máximo permitido es 2,147,483,647
                          </span>
                          <span *ngIf="f['idOtsAnterior'].errors?.['pattern']">
                            Solo se permiten números enteros
                          </span>
                        </div>
                        <div class="text-muted small ms-auto">
                          <span *ngIf="form.value.idOtsAnterior">
                            {{ form.value.idOtsAnterior.toString().length || 0 }}/10 dígitos
                          </span>
                        </div>
                      </div>
                    </div>

                    <!-- Descripción -->
                    <div class="col-12">
                      <label class="form-label fw-semibold small">
                        <i class="bi bi-text-paragraph me-1"></i> Descripción <span class="text-danger">*</span>
                        <span *ngIf="!isEditMode" class="badge bg-info bg-opacity-10 text-info ms-2">
                          <i class="bi bi-magic me-1"></i> Automática
                        </span>
                      </label>
                      <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-card-text"></i></span>
                        <textarea class="form-control" formControlName="descripcion" rows="2"
                                  [readonly]="!isEditMode"
                                  placeholder="La descripción se generará automáticamente según su selección..."
                                  [class.is-invalid]="submitted && f['descripcion'].invalid"></textarea>
                      </div>
                      <div class="d-flex justify-content-between mt-1">
                        <div *ngIf="submitted && f['descripcion'].invalid" class="text-danger small">
                          <i class="bi bi-exclamation-triangle me-1"></i> Mínimo 10 caracteres
                        </div>
                        <div class="text-muted small ms-auto">
                          {{ form.value.descripcion?.length || 0 }} caracteres
                        </div>
                      </div>
                    </div>

                    <!-- Vista Preliminar (solo en creación) -->
                    <div *ngIf="!isEditMode" class="col-12">
                      <div class="card border mt-2">
                        <div class="card-header bg-light py-2">
                          <h6 class="mb-0 small">
                            <i class="bi bi-eye me-2"></i>
                            Vista Preliminar
                          </h6>
                        </div>
                        <div class="card-body py-2">
                          <div class="row g-1">
                            <div class="col-md-3 col-6">
                              <small class="text-muted d-block">Cliente</small>
                              <div class="fw-semibold text-truncate small">{{ clienteNombre || '—' }}</div>
                            </div>
                            <div class="col-md-3 col-6">
                              <small class="text-muted d-block">Área</small>
                              <div class="fw-semibold text-truncate small">{{ areaNombre || '—' }}</div>
                            </div>
                            <div class="col-md-3 col-6">
                              <small class="text-muted d-block">Proyecto</small>
                              <div class="fw-semibold text-truncate small">{{ proyectoNombre || '—' }}</div>
                            </div>
                            <div class="col-md-3 col-6">
                              <small class="text-muted d-block">Site</small>
                              <div class="fw-semibold text-truncate small">{{ siteNombre || '—' }}</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Acciones del Paso 1 (ahora afuera del scroll) -->
                <div class="card-footer bg-white border-0 py-2 px-3 border-top">
                  <div class="d-flex justify-content-between align-items-center">
                    <button type="button" class="btn btn-outline-secondary btn-sm" (click)="resetForm()" [disabled]="isViewMode">
                      <i class="bi bi-arrow-clockwise me-1"></i>
                      {{ isEditMode ? 'Descartar' : 'Reiniciar' }}
                    </button>
                    <div class="d-flex gap-2">
                      <button type="button" class="btn btn-outline-dark btn-sm" (click)="onCancel()">
                        <i class="bi bi-x-circle me-1"></i>
                        Cancelar
                      </button>
                      <button type="button" class="btn btn-primary btn-sm" (click)="cambiarPaso(2)" [disabled]="isViewMode">
                        Siguiente
                        <i class="bi bi-arrow-right ms-1"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Paso 2: Responsables -->
            <div *ngIf="currentStep === 2" class="animate__animated animate__fadeIn">
              <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-white border-0 py-2 px-3">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h3 class="h6 mb-1 text-primary fw-bold">
                        <i class="bi bi-people me-2"></i>
                        Responsables y Contactos
                      </h3>
                      <p class="text-muted mb-0 small">Defina las personas responsables de la orden de trabajo</p>
                    </div>
                    <span class="badge bg-primary bg-opacity-10 text-primary small">Paso 2 de 3</span>
                  </div>
                </div>

                <div class="card-body px-3 py-3">
                  <div class="row g-2">
                    <!-- Columna Cliente -->
                    <div class="col-lg-6">
                      <div class="card h-100 border">
                        <div class="card-header bg-light py-2">
                          <h6 class="mb-0 text-primary small">
                            <i class="bi bi-building me-2"></i>
                            Cliente Solicitante
                          </h6>
                        </div>
                        <div class="card-body py-2">
                          <!-- Jefatura Cliente -->
                          <div class="mb-2">
                            <label class="form-label fw-semibold small">
                              Jefatura Cliente <span class="text-danger">*</span>
                            </label>
                            <app-ngselect-dropdown
                              [items]="jefaturasCliente"
                              [placeholder]="'Seleccione jefatura'"
                              [loading]="loading"
                              [isInvalid]="submitted && f['idJefaturaClienteSolicitante'].invalid"
                              [required]="true"
                              (selectionChange)="onJefaturaClienteChange($event)">
                            </app-ngselect-dropdown>
                          </div>

                          <!-- Analista Cliente -->
                          <div class="mb-2">
                            <label class="form-label fw-semibold small">
                              Analista Cliente <span class="text-danger">*</span>
                            </label>
                            <app-ngselect-dropdown
                              [items]="analistasCliente"
                              [placeholder]="'Seleccione analista'"
                              [loading]="loading"
                              [isInvalid]="submitted && f['idAnalistaClienteSolicitante'].invalid"
                              [required]="true"
                              (selectionChange)="onAnalistaClienteChange($event)">
                            </app-ngselect-dropdown>
                          </div>

                          <!-- Coordinador TI/CW -->
                          <div class="mb-2">
                            <label class="form-label fw-semibold small">
                              Coordinador TI/CW <span class="text-danger">*</span>
                            </label>
                            <app-ngselect-dropdown
                              [items]="coordinadoresTiCw"
                              [placeholder]="'Seleccione coordinador'"
                              [loading]="loading"
                              [isInvalid]="submitted && f['idCoordinadorTiCw'].invalid"
                              [required]="true"
                              (selectionChange)="onCoordinadorTiCwChange($event)">
                            </app-ngselect-dropdown>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Columna Responsables Internos -->
                    <div class="col-lg-6 mt-2 mt-lg-0">
                      <div class="card h-100 border">
                        <div class="card-header bg-light py-2">
                          <h6 class="mb-0 text-primary small">
                            <i class="bi bi-gear me-2"></i>
                            Responsables Internos
                          </h6>
                        </div>
                        <div class="card-body py-2">
                          <!-- Jefatura Responsable -->
                          <div class="mb-2">
                            <label class="form-label fw-semibold small">
                              Jefatura Responsable <span class="text-danger">*</span>
                            </label>
                            <app-ngselect-dropdown
                              [items]="jefaturasResponsable"
                              [placeholder]="'Seleccione jefatura'"
                              [loading]="loading"
                              [isInvalid]="submitted && f['idJefaturaResponsable'].invalid"
                              [required]="true"
                              (selectionChange)="onJefaturaResponsableChange($event)">
                            </app-ngselect-dropdown>
                          </div>

                          <!-- Liquidador -->
                          <div class="mb-2">
                            <label class="form-label fw-semibold small">
                              Liquidador <span class="text-danger">*</span>
                            </label>
                            <app-ngselect-dropdown
                              [items]="liquidadores"
                              [placeholder]="'Seleccione liquidador'"
                              [loading]="loading"
                              [isInvalid]="submitted && f['idLiquidador'].invalid"
                              [required]="true"
                              (selectionChange)="onLiquidadorChange($event)">
                            </app-ngselect-dropdown>
                          </div>

                          <!-- Ejecutante -->
                          <div class="mb-2">
                            <label class="form-label fw-semibold small">
                              Ejecutante <span class="text-danger">*</span>
                            </label>
                            <app-ngselect-dropdown
                              [items]="ejecutantes"
                              [placeholder]="'Seleccione ejecutante'"
                              [loading]="loading"
                              [isInvalid]="submitted && f['idEjecutante'].invalid"
                              [required]="true"
                              (selectionChange)="onEjecutanteChange($event)">
                            </app-ngselect-dropdown>
                          </div>

                          <!-- Analista Contable -->
                          <div class="mb-2">
                            <label class="form-label fw-semibold small">
                              Analista Contable <span class="text-danger">*</span>
                            </label>
                            <app-ngselect-dropdown
                              [items]="analistasContable"
                              [placeholder]="'Seleccione analista'"
                              [loading]="loading"
                              [isInvalid]="submitted && f['idAnalistaContable'].invalid"
                              [required]="true"
                              (selectionChange)="onAnalistaContableChange($event)">
                            </app-ngselect-dropdown>
                          </div>

                          <!-- Estado OT (solo edición) -->
                          <div *ngIf="isEditMode" class="mb-2">
                            <label class="form-label fw-semibold small">
                              Estado OT <span class="text-danger">*</span>
                            </label>
                            <app-ngselect-dropdown
                              [items]="estadoOT"
                              [placeholder]="'Seleccione estado'"
                              [loading]="loading"
                              [isInvalid]="submitted && f['idEstadoOt'].invalid"
                              [required]="true"
                              (selectionChange)="onEstadoOTChange($event)">
                            </app-ngselect-dropdown>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Acciones del Paso 2 -->
                <div class="card-footer bg-white border-0 py-2 px-3 border-top">
                  <div class="d-flex justify-content-between align-items-center">
                    <button type="button" class="btn btn-outline-secondary btn-sm" (click)="cambiarPaso(1)">
                      <i class="bi bi-arrow-left me-1"></i>
                      Volver
                    </button>
                    <div class="d-flex gap-2">
                      <button type="button" class="btn btn-outline-warning btn-sm" (click)="resetForm()" [disabled]="isViewMode">
                        <i class="bi bi-arrow-clockwise me-1"></i>
                        Reiniciar Todo
                      </button>
                      <button type="button" class="btn btn-primary btn-sm" (click)="cambiarPaso(3)" [disabled]="isViewMode">
                        Siguiente
                        <i class="bi bi-arrow-right ms-1"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Paso 3: Confirmar -->
            <div *ngIf="currentStep === 3" class="animate__animated animate__fadeIn">
              <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-white border-0 py-2 px-3">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h3 class="h6 mb-1 text-primary fw-bold">
                        <i class="bi bi-check-circle me-2"></i>
                        Confirmación Final
                      </h3>
                      <p class="text-muted mb-0 small">Revise y confirme la información antes de guardar</p>
                    </div>
                    <span class="badge bg-success bg-opacity-10 text-success small">Paso 3 de 3</span>
                  </div>
                </div>

                <div class="card-body px-3 py-3">
                  <!-- Alerta Compacta -->
                  <div class="alert alert-success border-0 bg-success bg-opacity-10 mb-3 py-2">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-check-circle-fill text-success fs-5 me-2"></i>
                      <div>
                        <h6 class="alert-heading mb-1 fw-semibold small">¡Todo listo!</h6>
                        <p class="mb-0 small">Verifique que toda la información sea correcta antes de proceder.</p>
                      </div>
                    </div>
                  </div>

                  <!-- Resumen -->
                  <div class="row g-2">
                    <!-- Información Principal -->
                    <div class="col-lg-6">
                      <div class="card h-100 border">
                        <div class="card-header bg-light py-2">
                          <h6 class="mb-0 small">
                            <i class="bi bi-card-checklist me-2"></i>
                            Información Principal
                          </h6>
                        </div>
                        <div class="card-body py-2">
                          <dl class="row mb-0 small">
                            <dt class="col-sm-5 text-muted">Cliente</dt>
                            <dd class="col-sm-7">{{ clienteNombre || '—' }}</dd>

                            <dt class="col-sm-5 text-muted">Área</dt>
                            <dd class="col-sm-7">{{ areaNombre || '—' }}</dd>

                            <dt class="col-sm-5 text-muted">Proyecto</dt>
                            <dd class="col-sm-7">{{ proyectoNombre || '—' }}</dd>

                            <dt class="col-sm-5 text-muted">Fase</dt>
                            <dd class="col-sm-7">{{ faseNombre || '—' }}</dd>

                            <dt class="col-sm-5 text-muted">Site</dt>
                            <dd class="col-sm-7">{{ siteNombre || '—' }}</dd>

                            <dt class="col-sm-5 text-muted">Región</dt>
                            <dd class="col-sm-7">{{ regionNombre || '—' }}</dd>

                            <dt class="col-sm-5 text-muted">Tipo OT</dt>
                            <dd class="col-sm-7">{{ tipoOtNombre || '—' }}</dd>

                            <dt class="col-sm-5 text-muted">Fecha Apertura</dt>
                            <dd class="col-sm-7">{{ fechaAperturaFormatted || '—' }}</dd>

                            <dt class="col-sm-5 text-muted">OT Anterior</dt>
                            <dd class="col-sm-7">
                              <span [ngClass]="{'text-danger fw-bold': form.value.idOtsAnterior > 2147483647,
                                             'text-muted': !form.value.idOtsAnterior}">
                                {{ form.value.idOtsAnterior || 'No especificada' }}
                                <span *ngIf="form.value.idOtsAnterior > 2147483647" class="badge bg-danger ms-2">
                                  <i class="bi bi-exclamation-triangle me-1"></i>Excede límite
                                </span>
                              </span>
                            </dd>
                          </dl>

                          <div class="mt-3 pt-2 border-top">
                            <h6 class="text-muted mb-1 small">Descripción</h6>
                            <div class="bg-light p-2 rounded small">
                              <p class="mb-0 text-truncate">{{ form.value.descripcion || 'Descripción automática' }}</p>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Responsables -->
                    <div class="col-lg-6 mt-2 mt-lg-0">
                      <div class="card h-100 border">
                        <div class="card-header bg-light py-2">
                          <h6 class="mb-0 small">
                            <i class="bi bi-people me-2"></i>
                            Responsables
                          </h6>
                        </div>
                        <div class="card-body py-2">
                          <dl class="row mb-0 small">
                            <dt class="col-sm-5 text-muted">Jefatura Cliente</dt>
                            <dd class="col-sm-7">{{ getItemNombre(selectedJefaturaClienteId, jefaturasCliente) || '—' }}</dd>

                            <dt class="col-sm-5 text-muted">Analista Cliente</dt>
                            <dd class="col-sm-7">{{ getItemNombre(selectedAnalistaClienteId, analistasCliente) || '—' }}</dd>

                            <dt class="col-sm-5 text-muted">Coordinador TI/CW</dt>
                            <dd class="col-sm-7">{{ getItemNombre(selectedCoordinadorTiCwId, coordinadoresTiCw) || '—' }}</dd>

                            <dt class="col-sm-5 text-muted">Jefatura Responsable</dt>
                            <dd class="col-sm-7">{{ getItemNombre(selectedJefaturaResponsableId, jefaturasResponsable) || '—' }}</dd>

                            <dt class="col-sm-5 text-muted">Liquidador</dt>
                            <dd class="col-sm-7">{{ getItemNombre(selectedLiquidadorId, liquidadores) || '—' }}</dd>

                            <dt class="col-sm-5 text-muted">Ejecutante</dt>
                            <dd class="col-sm-7">{{ getItemNombre(selectedEjecutanteId, ejecutantes) || '—' }}</dd>

                            <dt class="col-sm-5 text-muted">Analista Contable</dt>
                            <dd class="col-sm-7">{{ getItemNombre(selectedAnalistaContableId, analistasContable) || '—' }}</dd>

                            <div *ngIf="isEditMode">
                              <dt class="col-sm-5 text-muted">Estado OT</dt>
                              <dd class="col-sm-7">{{ getItemNombre(selectedEstadoOTId, estadoOT) || '—' }}</dd>
                            </div>
                          </dl>

                          <div class="mt-3 pt-2 border-top">
                            <h6 class="text-muted mb-1 small">Información del Sistema</h6>
                            <div class="row g-1">
                              <div class="col-6">
                                <small class="text-muted d-block">Usuario</small>
                                <div class="fw-semibold small">{{ usernameLogueado }}</div>
                              </div>
                              <div class="col-6">
                                <small class="text-muted d-block">Fecha</small>
                                <div class="fw-semibold small">{{ fechaActualFormatted }}</div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Validación Compacta -->
                  <div class="card border mt-2">
                    <div class="card-body py-2">
                      <h6 class="mb-2 small">
                        <i class="bi bi-shield-check me-2"></i>
                        Validación de Campos
                      </h6>
                      <div class="row">
                        <div class="col-md-6">
                          <div class="d-flex align-items-center mb-1">
                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                            <span class="small">Información Principal</span>
                            <span class="badge bg-success bg-opacity-10 text-success ms-auto small">Completa</span>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="d-flex align-items-center mb-1">
                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                            <span class="small">Responsables</span>
                            <span class="badge bg-success bg-opacity-10 text-success ms-auto small">Completa</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Acciones Finales -->
                <div class="card-footer bg-white border-0 py-2 px-3 border-top">
                  <div class="d-flex justify-content-between align-items-center">
                    <button type="button" class="btn btn-outline-secondary btn-sm" (click)="cambiarPaso(2)">
                      <i class="bi bi-arrow-left me-1"></i>
                      Volver
                    </button>
                    <div class="d-flex gap-2">
                      <button type="button" class="btn btn-outline-danger btn-sm" (click)="onCancel()">
                        <i class="bi bi-x-circle me-1"></i>
                        Cancelar
                      </button>
                      <button type="submit" class="btn btn-success btn-sm"
                              [disabled]="loadingSubmit || !form.valid || isViewMode">
                        <span *ngIf="!loadingSubmit">
                          <i class="bi" [ngClass]="isEditMode ? 'bi-save' : 'bi-plus-circle'"></i>
                          {{ isEditMode ? 'Guardar' : 'Crear OT' }}
                        </span>
                        <span *ngIf="loadingSubmit">
                          <span class="spinner-border spinner-border-sm me-1"></span>
                          {{ isEditMode ? 'Guardando...' : 'Creando...' }}
                        </span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Footer Estático -->
    <div class="form-footer bg-white border-top py-2 px-3">
      <div class="container-fluid px-0">
        <div class="row align-items-center">
          <div class="col-md-6">
            <div class="d-flex flex-wrap gap-2">
              <span class="text-muted small">
                <span class="text-danger">*</span> Campo obligatorio
              </span>
              <span class="text-muted small">
                <i class="bi bi-dash-circle me-1"></i> Campo opcional
              </span>
            </div>
          </div>
          <div class="col-md-6 text-md-end">
            <div class="d-flex gap-3 justify-content-md-end">
              <span class="text-primary fw-semibold small">
                <i class="bi bi-123 me-1"></i>
                Paso {{ currentStep }} de 3
              </span>
              <span class="fw-semibold small" [ngClass]="form.valid ? 'text-success' : 'text-warning'">
                <i class="bi" [ngClass]="form.valid ? 'bi-check-circle' : 'bi-exclamation-circle'"></i>
                {{ form.valid ? 'Válido' : 'Incompleto' }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
