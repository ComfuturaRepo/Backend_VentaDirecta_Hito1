<div class="container my-4">
  <div class="card shadow">
    <div class="card-header bg-primary text-white">
      <h4 class="mb-0">Crear SSOMA - Prueba de fotos</h4>
    </div>
    <div class="card-body">

      <form [formGroup]="ssomaForm">

        <!-- Tabs (simplificados para prueba) -->
        <ul class="nav nav-tabs mb-4">
          <li class="nav-item"><button class="nav-link" [class.active]="activeTab === 'ats'"     (click)="setTab('ats')">ATS</button></li>
          <li class="nav-item"><button class="nav-link" [class.active]="activeTab === 'capacitacion'" (click)="setTab('capacitacion')">Capacitaci贸n</button></li>
          <li class="nav-item"><button class="nav-link" [class.active]="activeTab === 'inspeccionEpp'" (click)="setTab('inspeccionEpp')">Inspecci贸n EPP</button></li>
        </ul>

        <div class="tab-content border p-4">

          <!-- ATS - Participantes -->
          <div *ngIf="activeTab === 'ats'" [formGroup]="atsForm">
            <h5>Participantes (ATS)</h5>
            <div formArrayName="participantes">
              <div *ngFor="let p of participantesArray.controls; let i = index" [formGroupName]="i" class="border p-3 mb-3 rounded">
                <div class="input-group mb-2">
                  <select class="form-select" formControlName="idTrabajador">
                    <option value="">Seleccionar trabajador</option>
                    <option *ngFor="let t of trabajadores" [value]="t.id">{{t.nombre}}</option>
                  </select>
                  <button class="btn btn-outline-primary" type="button" (click)="openCamera('participantes', i)">
                     Tomar foto
                  </button>
                  <button class="btn btn-outline-danger" type="button" (click)="removeParticipante(i)"></button>
                </div>
                <div *ngIf="getFoto('participantes', i)" class="text-center mt-2">
                  <img [src]="getFoto('participantes', i)!" alt="Foto" style="max-width: 180px; border-radius: 8px;">
                </div>
              </div>
            </div>
            <button type="button" class="btn btn-sm btn-primary" (click)="addParticipante()">+ Participante</button>
          </div>

          <!-- Capacitaci贸n - Asistentes -->
          <div *ngIf="activeTab === 'capacitacion'" [formGroup]="capacitacionForm">
            <h5>Asistentes (Capacitaci贸n)</h5>
            <div formArrayName="asistentes">
              <div *ngFor="let a of asistentesArray.controls; let i = index" [formGroupName]="i" class="border p-3 mb-3 rounded">
                <div class="input-group mb-2">
                  <select class="form-select" formControlName="idTrabajador">
                    <option value="">Seleccionar</option>
                    <option *ngFor="let t of trabajadores" [value]="t.id">{{t.nombre}}</option>
                  </select>
                  <button class="btn btn-outline-primary" type="button" (click)="openCamera('asistentes', i)">
                     Tomar foto
                  </button>
                  <button class="btn btn-outline-danger" type="button" (click)="removeAsistente(i)"></button>
                </div>
                <div *ngIf="getFoto('asistentes', i)" class="text-center mt-2">
                  <img [src]="getFoto('asistentes', i)!" alt="Foto" style="max-width: 180px; border-radius: 8px;">
                </div>
              </div>
            </div>
            <button type="button" class="btn btn-sm btn-primary" (click)="addAsistente()">+ Asistente</button>
          </div>

          <!-- Inspecci贸n EPP -->
          <div *ngIf="activeTab === 'inspeccionEpp'" [formGroup]="inspeccionEppForm">
            <h5>Inspecci贸n EPP</h5>
            <div formArrayName="detalles">
              <div *ngFor="let d of detallesEppArray.controls; let i = index" [formGroupName]="i" class="border p-3 mb-3 rounded">
                <div class="row g-2 mb-2">
                  <div class="col-md-5">
                    <select class="form-select" formControlName="idTrabajador">
                      <option value="">Trabajador</option>
                      <option *ngFor="let t of trabajadores" [value]="t.id">{{t.nombre}}</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <select class="form-select" formControlName="idEpp">
                      <option value="">EPP</option>
                      <option *ngFor="let e of epps" [value]="e.id">{{e.nombre}}</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <button class="btn btn-outline-primary w-100 mb-2" type="button" (click)="openCamera('detallesEpp', i)">
                       Foto
                    </button>
                    <button class="btn btn-outline-danger w-100" type="button" (click)="removeDetalleEpp(i)">Eliminar</button>
                  </div>
                </div>
                <div *ngIf="getFoto('detallesEpp', i)" class="text-center mt-2">
                  <img [src]="getFoto('detallesEpp', i)!" alt="Foto EPP" style="max-width: 180px; border-radius: 8px;">
                </div>
              </div>
            </div>
            <button type="button" class="btn btn-sm btn-success" (click)="addDetalleEpp()">+ Agregar</button>
          </div>

        </div>

        <div class="mt-4 text-center">
          <button type="button" class="btn btn-lg btn-success" (click)="onSubmit()">
            Ver datos en consola (prueba)
          </button>
        </div>

      </form>
    </div>
  </div>

  <!-- Modal de c谩mara -->
  <div class="modal fade" [class.show]="showCameraModal" [style.display]="showCameraModal ? 'block' : 'none'" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Tomar foto</h5>
          <button type="button" class="btn-close" (click)="closeCameraModal()"></button>
        </div>
        <div class="modal-body text-center">
          <video id="cameraVideo" autoplay playsinline style="width:100%; max-height:420px; background:#000;"></video>
          <canvas id="photoCanvas" style="display:none;"></canvas>

          <div *ngIf="fotoPreview" class="mt-3">
            <h6>Vista previa:</h6>
            <img [src]="fotoPreview" alt="Vista previa" style="max-width:320px; border:3px solid #198754; border-radius:8px;">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeCameraModal()">Cancelar</button>
          <button type="button" class="btn btn-primary" (click)="capturePhoto()">Capturar</button>
          <button type="button" class="btn btn-success" *ngIf="fotoPreview" (click)="savePhoto()">Guardar foto</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-backdrop fade show" *ngIf="showCameraModal"></div>
</div>
