<div class="container-fluid px-4 py-3 bg-light min-vh-100">
  <!-- Notificaciones -->
  <div class="notifications-container" *ngIf="notifications.length > 0">
    <div *ngFor="let notification of notifications"
         class="alert alert-dismissible fade show mb-2 shadow-sm"
         [ngClass]="getAlertClass(notification.type)"
         role="alert">
      <i class="bi me-2" [ngClass]="getAlertIcon(notification.type)"></i>
      <strong *ngIf="notification.title">{{ notification.title }}: </strong>
      {{ notification.message }}
      <button type="button" class="btn-close" (click)="removeNotification(notification)"></button>
    </div>
    <div class="text-end mb-2">
      <button class="btn btn-sm btn-outline-secondary shadow-sm" (click)="clearNotifications()">
        Limpiar todas
      </button>
    </div>
  </div>

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-0 text-dark">
        <i class="bi bi-people me-2"></i>Clientes
      </h1>
      <p class="text-muted mb-0">Gestión de clientes del sistema</p>
    </div>
    <button class="btn btn-primary" (click)="openCreateModal()" [disabled]="isLoading"    *appPermiso="'CLIENTE_MANAGE'"
  >
      <i class="bi bi-plus-circle me-2"></i>
      Nuevo Cliente
    </button>
  </div>

  <!-- Tarjetas de estadísticas -->
  <div class="row mb-4">
    <div class="col-md-3 mb-3">
      <div class="card border-0 bg-white shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-uppercase text-muted small">Total</h6>
              <h3 class="mb-0 fw-bold">
                {{ pageResponse.totalItems || 0 }}
              </h3>
            </div>
            <div class="bg-light p-3 rounded-circle">
              <i class="bi bi-people-fill text-primary fs-4"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card border-0 bg-white shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-uppercase text-muted small">Activos</h6>
              <h3 class="mb-0 fw-bold text-success">
                {{ activeClientsCount }}
              </h3>
            </div>
            <div class="bg-light p-3 rounded-circle">
              <i class="bi bi-check-circle-fill text-success fs-4"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card border-0 bg-white shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-uppercase text-muted small">Inactivos</h6>
              <h3 class="mb-0 fw-bold text-danger">
                {{ inactiveClientsCount }}
              </h3>
            </div>
            <div class="bg-light p-3 rounded-circle">
              <i class="bi bi-x-circle-fill text-danger fs-4"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card border-0 bg-white shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-uppercase text-muted small">Página</h6>
           <!-- Cambia a: -->
<h3 class="mb-0 fw-bold text-info">
  {{ currentPage + 1 }} / {{ pageResponse.totalPages || 1 }}
</h3>
            </div>
            <div class="bg-light p-3 rounded-circle">
              <i class="bi bi-file-text-fill text-info fs-4"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Panel de filtros -->
  <div class="card border-0 bg-white shadow-sm mb-4">
    <div class="card-body">
      <div class="row g-3">
        <!-- Barra de búsqueda -->
        <div class="col-md-6 col-lg-5">
          <div class="input-group">
            <span class="input-group-text bg-white">
              <i class="bi bi-search text-muted"></i>
            </span>
            <input type="text"
                   class="form-control"
                   placeholder="Buscar por razón social o RUC..."
                   [(ngModel)]="searchTerm"
                   (input)="onSearch(searchTerm)"
                   [disabled]="isLoading">
            <button *ngIf="searchTerm"
                    class="btn btn-outline-secondary"
                    type="button"
                    (click)="searchTerm = ''; onSearch('')"
                    [disabled]="isLoading">
              <i class="bi bi-x"></i>
            </button>
          </div>
        </div>

        <!-- Filtros rápidos -->
        <div class="col-md-6 col-lg-4">
          <div class="d-flex align-items-center h-100">
            <div class="btn-group" role="group">
              <button type="button"
                      class="btn btn-outline-secondary"
                      [class.active]="filterActivo === null"
                      (click)="onFilterChange('all')"
                      [disabled]="isLoading">
                Todos
              </button>
              <button type="button"
                      class="btn btn-outline-success"
                      [class.active]="filterActivo === true"
                      (click)="onFilterChange('activos')"
                      [disabled]="isLoading">
                Activos
              </button>
              <button type="button"
                      class="btn btn-outline-danger"
                      [class.active]="filterActivo === false"
                      (click)="onFilterChange('inactivos')"
                      [disabled]="isLoading">
                Inactivos
              </button>
            </div>
          </div>
        </div>

        <!-- Botón limpiar -->
        <div class="col-md-12 col-lg-3">
          <div class="d-flex justify-content-end h-100">
            <button class="btn btn-outline-warning"
                    (click)="clearFilters()"
                    [disabled]="isLoading || (!searchTerm && filterActivo === null)">
              <i class="bi bi-eraser me-2"></i>
              Limpiar Filtros
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla de clientes -->
  <div class="card border-0 bg-white shadow-sm">
    <div class="card-header bg-white d-flex justify-content-between align-items-center border-bottom">
      <h5 class="mb-0 text-dark">
        <i class="bi bi-table me-2"></i>Lista de Clientes
      </h5>
      <div class="d-flex align-items-center gap-2">
     <span class="text-muted small me-3">
  Mostrando {{ clientes.length }} de {{ pageResponse.totalItems || 0 }}
</span>
        <button class="btn btn-sm btn-outline-secondary" (click)="onRefresh()" [disabled]="isLoading">
          <i class="bi bi-arrow-clockwise"></i>
        </button>
      </div>
    </div>

    <div class="card-body p-0">
      <!-- Loading State -->
      <div *ngIf="isLoading" class="text-center py-5">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-3 text-muted">Cargando clientes...</p>
      </div>

      <!-- Tabla -->
      <div *ngIf="!isLoading">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th width="80" class="text-center">ID</th>
                <th>Razón Social</th>
                <th>RUC</th>
                <th>Áreas</th>
                <th width="100" class="text-center">Estado</th>
                <th width="180" class="text-center">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let cliente of clientes" class="align-middle">
                <td class="text-center">
                  <span class="badge bg-light text-dark">
                    #{{ cliente.idCliente }}
                  </span>
                </td>
                <td>
                  <div class="fw-semibold">{{ cliente.razonSocial }}</div>
                </td>
                <td>
                  <code>{{ cliente.ruc }}</code>
                </td>
                <td>
                  <div class="d-flex flex-wrap gap-1">
                    <span *ngFor="let area of cliente.areas"
                          class="badge bg-light text-dark border">
                      {{ area.nombre }}
                    </span>
                    <span *ngIf="!cliente.areas || cliente.areas.length === 0"
                          class="text-muted small">
                      Sin áreas
                    </span>
                  </div>
                </td>
                <td class="text-center">
                  <span class="badge" [ngClass]="getStatusClass(cliente.activo)">
                    {{ getStatusText(cliente.activo) }}
                  </span>
                </td>
                <td class="text-center">
                  <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-primary"
                            (click)="openEditModal(cliente)"  *appPermiso="'CLIENTE_MANAGE'"
                            title="Editar">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn"
                            [class]="cliente.activo ? 'btn-outline-warning' : 'btn-outline-success'"
                            (click)="toggleStatus(cliente)"   *appPermiso="'CLIENTE_MANAGE'"
                            [title]="cliente.activo ? 'Desactivar' : 'Activar'">
                      <i [class]="cliente.activo ? 'bi bi-eye-slash' : 'bi bi-eye'"></i>
                    </button>
                    <button class="btn btn-outline-danger"
                            (click)="deleteCliente(cliente)"   *appPermiso="'CLIENTE_MANAGE'"
                            title="Eliminar">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Sin resultados -->
        <div *ngIf="clientes.length === 0" class="text-center py-5">
          <i class="bi bi-people display-1 text-muted opacity-50"></i>
          <h4 class="fw-bold mb-3 text-dark">No se encontraron clientes</h4>
          <p class="text-muted mb-4">
            {{ searchTerm || filterActivo !== null
              ? 'No hay resultados para los filtros aplicados'
              : 'No hay clientes registrados en el sistema' }}
          </p>
          <button *ngIf="!searchTerm && filterActivo === null"
                  class="btn btn-primary"
                  (click)="openCreateModal()">
            <i class="bi bi-plus-circle me-2"></i>
            Crear primer cliente
          </button>
        </div>
      </div>
    </div>

    <!-- Paginación -->
    <div *ngIf="pageResponse && pageResponse.totalPages > 1" class="card-footer bg-white border-top">
      <app-pagination
        [currentPage]="currentPage"
        [totalItems]="pageResponse.totalItems"
        [totalPages]="pageResponse.totalPages"
        [pageSize]="pageSize"
        (pageChange)="onPageChange($event)"
        (pageSizeChange)="onPageSizeChange($event)"
        (refresh)="onRefresh()"
        [isLoading]="isLoading"
        [showInfo]="true"
        [showJumpToPage]="true"
        [showSizeSelector]="true"
        align="center"
        size="sm">
      </app-pagination>
    </div>
  </div>
</div>

<!-- Modal de Cliente -->
<ng-template #clienteModal let-modal>
  <div class="modal-header bg-white border-bottom">
    <h5 class="modal-title text-dark">
      {{ editMode ? 'Editar Cliente' : 'Nuevo Cliente' }}
    </h5>
    <button type="button" class="btn-close" (click)="modal.dismiss()"
            [disabled]="isSubmitting"></button>
  </div>

  <div class="modal-body">
    <form [formGroup]="clienteForm" (ngSubmit)="saveCliente()">
      <!-- Razón Social -->
      <div class="mb-3">
        <label class="form-label required">Razón Social</label>
        <input type="text"
               class="form-control"
               formControlName="razonSocial"
               [class.is-invalid]="razonSocial?.invalid && (razonSocial?.dirty || razonSocial?.touched)"
               placeholder="Ingrese la razón social">
        <div *ngIf="razonSocial?.invalid && (razonSocial?.dirty || razonSocial?.touched)"
             class="invalid-feedback">
          <div *ngIf="razonSocial?.errors?.['required']">
            La razón social es requerida
          </div>
          <div *ngIf="razonSocial?.errors?.['minlength']">
            Mínimo 3 caracteres
          </div>
          <div *ngIf="razonSocial?.errors?.['maxlength']">
            Máximo 150 caracteres
          </div>
        </div>
      </div>

      <!-- RUC -->
      <div class="mb-3">
        <label class="form-label required">RUC</label>
        <input type="text"
               class="form-control"
               formControlName="ruc"
               [class.is-invalid]="ruc?.invalid && (ruc?.dirty || ruc?.touched)"
               placeholder="11 dígitos"
               maxlength="11">
        <div *ngIf="ruc?.invalid && (ruc?.dirty || ruc?.touched)"
             class="invalid-feedback">
          <div *ngIf="ruc?.errors?.['required']">
            El RUC es requerido
          </div>
          <div *ngIf="ruc?.errors?.['pattern']">
            El RUC debe tener exactamente 11 dígitos
          </div>
        </div>
        <small class="form-text text-muted">
          Debe contener exactamente 11 dígitos numéricos
        </small>
      </div>

      <!-- Áreas -->
      <div class="mb-4">
        <label class="form-label required d-flex justify-content-between align-items-center">
          <span>Áreas Asignadas</span>
          <button type="button" class="btn btn-sm btn-outline-primary" (click)="openAreaModal()">
            <i class="bi bi-plus me-1"></i>Nueva Área
          </button>
        </label>

        <!-- Creación rápida de área -->
        <div *ngIf="showAreaInput" class="mb-3">
          <div class="input-group">
            <input type="text"
                   class="form-control"
                   [(ngModel)]="newAreaName"
                   [ngModelOptions]="{standalone: true}"
                   id="newAreaInput"
                   placeholder="Nombre de nueva área"
                   (keydown.enter)="createAreaQuick()">
            <button class="btn btn-success" type="button" (click)="createAreaQuick()" [disabled]="isCreatingArea">
              <i class="bi" [class]="isCreatingArea ? 'bi-hourglass-split' : 'bi-check'"></i>
            </button>
            <button class="btn btn-outline-secondary" type="button" (click)="toggleAreaInput()">
              <i class="bi bi-x"></i>
            </button>
          </div>
          <small class="form-text text-muted">Presione Enter para crear</small>
        </div>

        <!-- Botón para mostrar input -->
        <button *ngIf="!showAreaInput" type="button" class="btn btn-outline-secondary btn-sm mb-3" (click)="toggleAreaInput()">
          <i class="bi bi-plus-circle me-1"></i>Crear área rápida
        </button>

        <div *ngIf="areasDropdown.length === 0" class="alert alert-warning">
          <i class="bi bi-exclamation-triangle me-2"></i>
          No hay áreas disponibles. Crea áreas primero.
        </div>

        <div *ngIf="areasDropdown.length > 0" class="card border">
          <div class="card-body">
            <div class="row">
             <!-- En el modal de cliente, en la lista de checkboxes -->
<div *ngFor="let area of areasDropdown" class="col-md-6 mb-2">
  <div class="form-check">
    <input class="form-check-input"
           type="checkbox"
           [id]="'area-' + area.id"
           [value]="area.id"
           [checked]="areaIds?.value?.includes(area.id)"
           (change)="onAreaToggle(area.id)">
    <label class="form-check-label" [for]="'area-' + area.id">
      {{ area.label }}
      <!-- Muestra el estado -->
      <span class="badge" [ngClass]="area.estado ? 'bg-success' : 'bg-danger'" style="font-size: 0.7em;">
        {{ area.estado ? 'Activo' : 'Inactivo' }}
      </span>
    </label>
  </div>
</div>
            </div>

            <div *ngIf="areaIds?.invalid && (areaIds?.touched || areaIds?.dirty)"
                 class="alert alert-danger mt-3">
              <i class="bi bi-exclamation-circle me-2"></i>
              Debe seleccionar al menos un área
            </div>
          </div>
        </div>
      </div>

      <!-- Estado -->
      <div *ngIf="editMode" class="mb-3">
        <div class="form-check form-switch">
          <input class="form-check-input"
                 type="checkbox"
                 role="switch"
                 formControlName="activo"
                 [id]="'activo-' + selectedClienteId">
          <label class="form-check-label" [for]="'activo-' + selectedClienteId">
            Cliente Activo
          </label>
        </div>
      </div>
    </form>
  </div>

  <div class="modal-footer bg-white border-top">
    <button type="button"
            class="btn btn-outline-secondary"
            (click)="modal.dismiss()"
            [disabled]="isSubmitting">
      Cancelar
    </button>
    <button type="submit"
            class="btn btn-primary"
            (click)="saveCliente()"
            [disabled]="clienteForm.invalid || isSubmitting">
      <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2"></span>
      {{ isSubmitting ? 'Guardando...' : (editMode ? 'Actualizar' : 'Crear') }}
    </button>
  </div>
</ng-template>

<!-- Modal de Área -->
<ng-template #areaModal let-modal>
  <div class="modal-header bg-white border-bottom">
    <h5 class="modal-title text-dark">Nueva Área</h5>
    <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
  </div>

  <div class="modal-body">
    <form [formGroup]="areaForm" (ngSubmit)="saveArea()">
      <div class="mb-3">
        <label class="form-label required">Nombre del Área</label>
        <input type="text"
               class="form-control"
               formControlName="nombre"
               [class.is-invalid]="areaNombre?.invalid && (areaNombre?.dirty || areaNombre?.touched)"
               placeholder="Ingrese el nombre del área"
               autofocus>
        <div *ngIf="areaNombre?.invalid && (areaNombre?.dirty || areaNombre?.touched)"
             class="invalid-feedback">
          <div *ngIf="areaNombre?.errors?.['required']">
            El nombre es requerido
          </div>
          <div *ngIf="areaNombre?.errors?.['minlength']">
            Mínimo 2 caracteres
          </div>
        </div>
        <small class="form-text text-muted">
          El nombre del área debe ser único
        </small>
      </div>
    </form>
  </div>

  <div class="modal-footer bg-white border-top">
    <button type="button"
            class="btn btn-outline-secondary"
            (click)="modal.dismiss()"
            [disabled]="isSubmitting">
      Cancelar
    </button>
    <button type="submit"
            class="btn btn-primary"
            (click)="saveArea()"
            [disabled]="areaForm.invalid || isSubmitting">
      <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2"></span>
      {{ isSubmitting ? 'Guardando...' : 'Crear' }}
    </button>
  </div>
</ng-template>
