<div class="container-fluid mt-4">
  <!-- Encabezado -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-white border-bottom">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h5 class="mb-0">
            <i class="bi bi-person-circle me-2"></i>Mi Perfil
          </h5>
          <small class="text-muted">Administra tu información personal y seguridad</small>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Columna izquierda - Información del perfil -->
    <div class="col-lg-8">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
              <i class="bi bi-person-vcard me-2"></i>Información Personal
            </h6>
            <button class="btn btn-sm btn-outline-primary"
                    (click)="toggleEditMode()"
                    [disabled]="isLoading">
              <i class="bi" [class.bi-pencil]="!isEditing" [class.bi-x]="isEditing"></i>
              {{ isEditing ? 'Cancelar' : 'Editar' }}
            </button>
          </div>
        </div>

        <div class="card-body">
          <!-- Estado de carga -->
          <div *ngIf="isLoading" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
          </div>

          <!-- Formulario de edición -->
          <form *ngIf="isEditing && !isLoading" [formGroup]="perfilForm" (ngSubmit)="savePerfil()">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Nombres</label>
                <input type="text"
                       class="form-control"
                       [class.is-invalid]="isFieldInvalid(perfilForm, 'nombres')"
                       formControlName="nombres"
                       placeholder="Ingrese sus nombres">
                <div *ngIf="isFieldInvalid(perfilForm, 'nombres')" class="invalid-feedback">
                  {{ getErrorMessage(perfilForm, 'nombres') }}
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Apellidos</label>
                <input type="text"
                       class="form-control"
                       [class.is-invalid]="isFieldInvalid(perfilForm, 'apellidos')"
                       formControlName="apellidos"
                       placeholder="Ingrese sus apellidos">
                <div *ngIf="isFieldInvalid(perfilForm, 'apellidos')" class="invalid-feedback">
                  {{ getErrorMessage(perfilForm, 'apellidos') }}
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Email Corporativo</label>
                <input type="email"
                       class="form-control"
                       [class.is-invalid]="isFieldInvalid(perfilForm, 'correoCorporativo')"
                       formControlName="correoCorporativo"
                       placeholder="ejemplo@empresa.com">
                <div *ngIf="isFieldInvalid(perfilForm, 'correoCorporativo')" class="invalid-feedback">
                  {{ getErrorMessage(perfilForm, 'correoCorporativo') }}
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Celular</label>
                <input type="tel"
                       class="form-control"
                       [class.is-invalid]="isFieldInvalid(perfilForm, 'celular')"
                       formControlName="celular"
                       placeholder="999888777">
                <div *ngIf="isFieldInvalid(perfilForm, 'celular')" class="invalid-feedback">
                  {{ getErrorMessage(perfilForm, 'celular') }}
                </div>
              </div>

              <div class="col-12">
                <div class="d-flex justify-content-end gap-2">
                  <button type="button"
                          class="btn btn-secondary"
                          (click)="toggleEditMode()"
                          [disabled]="isLoading">
                    Cancelar
                  </button>
                  <button type="submit"
                          class="btn btn-primary"
                          [disabled]="perfilForm.invalid || isLoading">
                    <span *ngIf="!isLoading">Guardar Cambios</span>
                    <span *ngIf="isLoading" class="spinner-border spinner-border-sm"></span>
                  </button>
                </div>
              </div>
            </div>
          </form>

          <!-- Vista de solo lectura -->
          <div *ngIf="!isEditing && perfil && !isLoading" class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label text-muted">Nombres</label>
              <p class="mb-0 fw-semibold">{{ perfil.nombres || 'No especificado' }}</p>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label text-muted">Apellidos</label>
              <p class="mb-0 fw-semibold">{{ perfil.apellidos || 'No especificado' }}</p>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label text-muted">DNI</label>
              <p class="mb-0 fw-semibold">{{ perfil.dni || 'No especificado' }}</p>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label text-muted">Email Corporativo</label>
              <p class="mb-0 fw-semibold">{{ perfil.correoCorporativo || 'No especificado' }}</p>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label text-muted">Celular</label>
              <p class="mb-0 fw-semibold">{{ perfil.celular || 'No especificado' }}</p>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label text-muted">Usuario</label>
              <p class="mb-0 fw-semibold">{{ perfil.username || 'No especificado' }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Información laboral -->
      <div *ngIf="perfil" class="card shadow-sm">
        <div class="card-header bg-white">
          <h6 class="mb-0">
            <i class="bi bi-briefcase me-2"></i>Información Laboral
          </h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label text-muted">Empresa</label>
              <p class="mb-0 fw-semibold">{{ perfil.empresaNombre || 'No asignado' }}</p>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label text-muted">Área</label>
              <p class="mb-0 fw-semibold">{{ perfil.areaNombre || 'No asignado' }}</p>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label text-muted">Cargo</label>
              <p class="mb-0 fw-semibold">{{ perfil.cargoNombre || 'No asignado' }}</p>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label text-muted">Nivel de Acceso</label>
              <p class="mb-0">
                <span class="badge" [ngClass]="getNivelClass()">
                  <i class="bi" [class]="perfilService.getNivelIcon(perfil.nivelCodigo)"></i>
                  {{ perfil.nivelNombre }}
                </span>
              </p>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label text-muted">Fecha de Creación</label>
              <p class="mb-0 fw-semibold">{{ formatFecha(perfil.fechaCreacion) }}</p>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label text-muted">Estado</label>
              <p class="mb-0">
                <span class="badge" [ngClass]="perfil.activo ? 'bg-success' : 'bg-danger'">
                  {{ perfil.activo ? 'Activo' : 'Inactivo' }}
                </span>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Columna derecha - Avatar, seguridad, estadísticas -->
    <div class="col-lg-4">
      <!-- Avatar y acciones rápidas -->
      <div class="card shadow-sm mb-4">
        <div class="card-body text-center">
          <div class="avatar-xl bg-primary bg-gradient text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3">
            <span class="fs-3 fw-bold">{{ getAvatarText() }}</span>
          </div>
          <h5 class="mb-1">{{ perfil?.nombres }} {{ perfil?.apellidos }}</h5>
          <p class="text-muted mb-3">{{ perfil?.username }}</p>

          <div class="d-grid gap-2">
            <button class="btn btn-outline-primary" (click)="toggleChangePassword()">
              <i class="bi bi-key me-1"></i>Cambiar Contraseña
            </button>
          </div>
        </div>
      </div>

      <!-- Cambiar contraseña -->
      <div *ngIf="isChangingPassword" class="card shadow-sm mb-4">
        <div class="card-header bg-white">
          <h6 class="mb-0">
            <i class="bi bi-shield-lock me-2"></i>Cambiar Contraseña
          </h6>
        </div>
        <div class="card-body">
          <form [formGroup]="passwordForm" (ngSubmit)="changePassword()">
            <div class="mb-3">
              <label class="form-label">Contraseña Actual</label>
              <div class="input-group">
                <input [type]="showCurrentPassword ? 'text' : 'password'"
                       class="form-control"
                       [class.is-invalid]="isFieldInvalid(passwordForm, 'currentPassword')"
                       formControlName="currentPassword"
                       placeholder="Ingrese su contraseña actual">
                <button class="btn btn-outline-secondary"
                        type="button"
                        (click)="showCurrentPassword = !showCurrentPassword">
                  <i class="bi" [class.bi-eye]="!showCurrentPassword" [class.bi-eye-slash]="showCurrentPassword"></i>
                </button>
              </div>
              <div *ngIf="isFieldInvalid(passwordForm, 'currentPassword')" class="invalid-feedback d-block">
                {{ getErrorMessage(passwordForm, 'currentPassword') }}
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Nueva Contraseña</label>
              <div class="input-group">
                <input [type]="showNewPassword ? 'text' : 'password'"
                       class="form-control"
                       [class.is-invalid]="isFieldInvalid(passwordForm, 'newPassword')"
                       formControlName="newPassword"
                       placeholder="Ingrese nueva contraseña"
                       (input)="onPasswordInput()">
                <button class="btn btn-outline-secondary"
                        type="button"
                        (click)="showNewPassword = !showNewPassword">
                  <i class="bi" [class.bi-eye]="!showNewPassword" [class.bi-eye-slash]="showNewPassword"></i>
                </button>
              </div>
              <div *ngIf="isFieldInvalid(passwordForm, 'newPassword')" class="invalid-feedback d-block">
                {{ getErrorMessage(passwordForm, 'newPassword') }}
              </div>
              <small class="form-text text-muted">
                La contraseña debe tener al menos 6 caracteres, incluyendo mayúsculas, minúsculas, números y caracteres especiales.
              </small>
            </div>

            <div class="mb-3">
              <label class="form-label">Confirmar Contraseña</label>
              <div class="input-group">
                <input [type]="showConfirmPassword ? 'text' : 'password'"
                       class="form-control"
                       [class.is-invalid]="isFieldInvalid(passwordForm, 'confirmPassword')"
                       formControlName="confirmPassword"
                       placeholder="Confirme la nueva contraseña">
                <button class="btn btn-outline-secondary"
                        type="button"
                        (click)="showConfirmPassword = !showConfirmPassword">
                  <i class="bi" [class.bi-eye]="!showConfirmPassword" [class.bi-eye-slash]="showConfirmPassword"></i>
                </button>
              </div>
              <div *ngIf="isFieldInvalid(passwordForm, 'confirmPassword')" class="invalid-feedback d-block">
                {{ getErrorMessage(passwordForm, 'confirmPassword') }}
              </div>
            </div>

            <div class="d-flex justify-content-end gap-2">
              <button type="button"
                      class="btn btn-secondary"
                      (click)="toggleChangePassword()"
                      [disabled]="isLoading">
                Cancelar
              </button>
              <button type="submit"
                      class="btn btn-primary"
                      [disabled]="passwordForm.invalid || isLoading">
                <span *ngIf="!isLoading">Cambiar</span>
                <span *ngIf="isLoading" class="spinner-border spinner-border-sm"></span>
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Estadísticas -->
      <div *ngIf="perfil" class="card shadow-sm">
        <div class="card-header bg-white">
          <h6 class="mb-0">
            <i class="bi bi-graph-up me-2"></i>Actividad
          </h6>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-6 mb-3">
              <div class="p-3 bg-light rounded">
                <h4 class="mb-0 text-primary">{{ perfil.totalProyectos }}</h4>
                <small class="text-muted">Proyectos</small>
              </div>
            </div>
            <div class="col-6 mb-3">
              <div class="p-3 bg-light rounded">
                <h4 class="mb-0 text-warning">{{ perfil.tareasPendientes }}</h4>
                <small class="text-muted">Pendientes</small>
              </div>
            </div>
            <div class="col-6">
              <div class="p-3 bg-light rounded">
                <h4 class="mb-0 text-success">{{ perfil.tareasCompletadas }}</h4>
                <small class="text-muted">Completadas</small>
              </div>
            </div>
            <div class="col-6">
              <div class="p-3 bg-light rounded">
                <h4 class="mb-0 text-info">{{ perfil.ultimaConexion ? formatFechaRelativa(perfil.ultimaConexion) : 'Nunca' }}</h4>
                <small class="text-muted">Última conexión</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
