<div class="site-container">
  <!-- Header Principal -->
  <div class="site-header">
    <div class="header-content">
      <div class="header-left">
        <h1 class="page-title">
          <i class="bi bi-buildings me-2"></i>
          Gestión de Sitios
        </h1>
        <p class="page-subtitle">Administre y consulte todos los sitios registrados en el sistema</p>
      </div>
      <div class="header-right">
        <div class="stats-container">
          <div class="stat-card">
            <i class="bi bi-check-circle-fill text-success"></i>
            <div class="stat-info">
              <span class="stat-value">{{ getActiveSitesCount() }}</span>
              <span class="stat-label">Activos</span>
            </div>
          </div>
          <div class="stat-card">
            <i class="bi bi-x-circle-fill text-secondary"></i>
            <div class="stat-info">
              <span class="stat-value">{{ getInactiveSitesCount() }}</span>
              <span class="stat-label">Inactivos</span>
            </div>
          </div>
          <div class="stat-card">
            <i class="bi bi-collection-fill text-primary"></i>
            <div class="stat-info">
              <span class="stat-value">{{ getTotalSitesCount() }}</span>
              <span class="stat-label">Total</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Barra de Acciones y Búsqueda -->
  <div class="action-bar">
    <div class="action-left">
      <div class="search-container">
        <div class="search-wrapper">
          <i class="bi bi-search search-icon"></i>
          <input
            type="text"
            class="search-input"
            placeholder="Buscar por código, descripción..."
            [(ngModel)]="searchTerm"
            (input)="onSearchInput()"
            [disabled]="isTableLoading"
          >
          <button
            *ngIf="searchTerm"
            class="btn btn-clear-search"
            (click)="clearFilters()"
            [disabled]="isTableLoading"
          >
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
      </div>

      <!-- Filtros Rápidos -->
      <div class="quick-filters">
        <div class="filter-group">
          <span class="filter-label">Estado:</span>
          <div class="btn-group" role="group">
            <button
              type="button"
              class="btn btn-filter"
              [class.active]="filters.activo === undefined"
              (click)="changeFilterActivos(undefined)"
              [disabled]="isTableLoading"
            >
              <i class="bi bi-grid-3x3-gap"></i>
              Todos
            </button>
            <button
              type="button"
              class="btn btn-filter"
              [class.active]="filters.activo === true"
              (click)="changeFilterActivos(true)"
              [disabled]="isTableLoading"
            >
              <i class="bi bi-check-circle"></i>
              Activos
            </button>
            <button
              type="button"
              class="btn btn-filter"
              [class.active]="filters.activo === false"
              (click)="changeFilterActivos(false)"
              [disabled]="isTableLoading"
            >
              <i class="bi bi-x-circle"></i>
              Inactivos
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="action-right">


      <!-- Botón Nuevo Site -->
      <button
        class="btn btn-primary btn-new-site"
        (click)="openCreateModal()"
        [disabled]="isTableLoading"
      >
        <i class="bi bi-plus-lg"></i>
        Nuevo Site
      </button>
    </div>
  </div>

  <!-- Filtros Avanzados (Expandible) -->
  <div class="advanced-filters" [class.expanded]="showAdvancedFilters">
    <div class="filters-header">
      <h5 class="filters-title">
        <i class="bi bi-sliders"></i>
        Filtros Avanzados
      </h5>
      <div class="filters-summary" *ngIf="appliedFiltersCount > 0">
        <i class="bi bi-funnel-fill"></i>
        {{ getFilterSummary() }}
      </div>
      <button class="btn btn-close-filters" (click)="toggleAdvancedFilters()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <div class="filters-body">
      <div class="row g-3">
        <div class="col-md-6">
          <div class="form-group">
            <label class="form-label">
              <i class="bi bi-upc-scan"></i>
              Código específico
            </label>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="filters.codigoSitio"
              placeholder="Ej: ST-001"
              [disabled]="isTableLoading"
            >
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-group">
            <label class="form-label">
              <i class="bi bi-card-text"></i>
              Descripción contiene
            </label>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="filters.descripcion"
              placeholder="Ej: Oficina principal"
              [disabled]="isTableLoading"
            >
          </div>
        </div>
      </div>

      <div class="filters-actions">
     <button
  class="btn btn-primary btn-apply-filters"
  (click)="applyFilters()"
  [disabled]="isTableLoading"
>
  <i class="bi bi-check-lg"></i>
  Aplicar Filtros
  <span *ngIf="appliedFiltersCount > 0" class="filter-badge">
    {{ appliedFiltersCount }}
  </span>
</button>
        <button
          class="btn btn-outline-secondary btn-clear-all"
          (click)="clearFilters()"
          [disabled]="isTableLoading"
        >
          <i class="bi bi-arrow-counterclockwise"></i>
          Limpiar Filtros
        </button>
      </div>
    </div>
  </div>

  <!-- Tabla de Sites -->
  <div class="table-container">
    <div class="table-responsive">
      <table class="table table-hover table-striped">
        <thead>
          <tr>
            <th width="120">
              <div class="table-header">
                <i class="bi bi-hash"></i>
                Código
              </div>
            </th>
            <th>
              <div class="table-header">
                <i class="bi bi-card-text"></i>
                Descripción Principal
              </div>
            </th>
            <th width="120">
              <div class="table-header">
                <i class="bi bi-circle-fill"></i>
                Estado
              </div>
            </th>
            <th width="180">
              <div class="table-header">
                <i class="bi bi-calendar"></i>
                Fecha Creación
              </div>
            </th>
            <th width="150">
              <div class="table-header">
                <i class="bi bi-gear"></i>
                Acciones
              </div>
            </th>
          </tr>
        </thead>
        <tbody>
          <!-- Estado de carga -->
          <tr *ngIf="isTableLoading">
            <td colspan="5" class="loading-row">
              <div class="loading-content">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Cargando...</span>
                </div>
                <span class="loading-text">Cargando sitios...</span>
              </div>
            </td>
          </tr>

          <!-- Sin resultados -->
          <tr *ngIf="!isTableLoading && sites.length === 0">
            <td colspan="5" class="no-results-row">
              <div class="no-results-content">
                <i class="bi bi-inbox no-results-icon"></i>
                <div class="no-results-text">
                  <h5>No se encontraron sitios</h5>
                  <p *ngIf="hasActiveFilters()" class="text-muted">
                    {{ getFilterSummary() }}
                  </p>
                  <p *ngIf="!hasActiveFilters()" class="text-muted">
                    No hay sitios registrados en el sistema.
                  </p>
                </div>
              </div>
            </td>
          </tr>

          <!-- Lista de Sites -->
          <tr *ngFor="let site of sites" class="site-row">
            <td>
              <div class="site-code">
                <span class="code-text">{{ site.codigoSitio || 'N/A' }}</span>
              </div>
            </td>
            <td>
              <div class="site-desc">
                <div class="desc-main">
                  {{ getFirstDescripcion(site.descripciones) }}
                </div>
                <div *ngIf="site.descripciones.length > 1" class="desc-additional">
                  <small class="text-muted">
                    +{{ site.descripciones.length - 1 }} descripción{{ site.descripciones.length > 2 ? 'es' : '' }}
                  </small>
                </div>
              </div>
            </td>
            <td>
              <span
                class="badge status-badge"
                [class]="getStatusBadgeClass(site.activo)"
              >
                <i [class]="getStatusIcon(site.activo)"></i>
                {{ getStatusText(site.activo) }}
              </span>
            </td>
            <td>
              <div class="date-cell">
                <div class="date-text">
                  {{ site.fechaCreacion | date:'dd/MM/yyyy' }}
                </div>
                <div class="time-text">
                  {{ site.fechaCreacion | date:'HH:mm' }}
                </div>
              </div>
            </td>
            <td>
              <div class="action-buttons">
                <button
                  class="btn btn-sm btn-outline-primary btn-action"
                  (click)="openEditModal(site)"
                  [title]="'Editar sitio'"
                >
                  <i class="bi bi-pencil"></i>
                </button>
                <button
                  class="btn btn-sm btn-outline-warning btn-action"
                  (click)="toggleActivo(site)"
                  [title]="site.activo ? 'Desactivar' : 'Activar'"
                >
                  <i [class]="site.activo ? 'bi-toggle-off' : 'bi-toggle-on'"></i>
                </button>
                <button
                  class="btn btn-sm btn-outline-info btn-action"
                  (click)="openDuplicateModal()"
                  [title]="'Duplicar sitio'"
                  [disabled]="!selectedSiteId"
                >
                  <i class="bi bi-files"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Paginación -->
  <div class="pagination-wrapper">
    <app-pagination
      [currentPage]="currentPage"
      [totalItems]="totalElements"
      [totalPages]="totalPages"
      [pageSize]="pageSize"
      [showInfo]="paginationConfig.showInfo"
      [showSizeSelector]="paginationConfig.showSizeSelector"
      [showNavigation]="paginationConfig.showNavigation"
      [showJumpToPage]="paginationConfig.showJumpToPage"
      [showPageNumbers]="paginationConfig.showPageNumbers"
      [pageSizes]="paginationConfig.pageSizes"
      [align]="paginationConfig.align"
      [size]="paginationConfig.size"
      [isLoading]="isTableLoading"
      (pageChange)="onPageChange($event)"
      (pageSizeChange)="onPageSizeChange($event)"
      (refresh)="onRefresh()"
    ></app-pagination>
  </div>

  <!-- Modal para crear/editar Site -->
  <div class="modal-backdrop" [class.show]="showModal" (click)="closeModal()"></div>

  <div class="site-modal" [class.show]="showModal">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <!-- Header del Modal -->
      <div class="modal-header">
        <div class="modal-icon">
          <i class="bi" [class]="isEditMode ? 'bi-pencil-square' : 'bi-plus-circle'"></i>
        </div>
        <div class="modal-title">
          <h5>{{ isEditMode ? 'Editar Site' : 'Nuevo Site' }}</h5>
          <small class="text-muted">Complete todos los campos requeridos (*)</small>
        </div>
        <button type="button" class="btn-close" (click)="closeModal()" aria-label="Close"></button>
      </div>

      <!-- Body del Modal -->
      <div class="modal-body">
    <!-- En el modal body, después del campo de código -->
<div *ngIf="errorMessage && errorMessage.includes('código')" class="alert alert-warning alert-dismissible fade show mt-2" role="alert">
  <i class="bi bi-exclamation-triangle-fill me-2"></i>
  {{ errorMessage }}
  <button type="button" class="btn-close" (click)="errorMessage = ''"></button>
</div>

<form #siteForm="ngForm" (keydown.enter)="$event.preventDefault()">
          <!-- Código del Site -->
          <div class="form-group mb-4">
            <label class="form-label required">
              <i class="bi bi-upc-scan me-2"></i>
              Código del Site
            </label>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="currentSite.codigoSitio"
              name="codigoSitio"
              placeholder="Ej: ST-001, OFC-001"
              required
              maxlength="150"
              [class.is-invalid]="formSubmitted && (!currentSite.codigoSitio || currentSite.codigoSitio.trim() === '')"
              [disabled]="isLoading"
            >
            <div class="invalid-feedback">
              El código del site es requerido
            </div>
            <div class="form-text">
              Código único identificador del site. Máximo 150 caracteres.
            </div>
          </div>

          <!-- Estado -->
          <div class="form-group mb-4">
            <label class="form-label">
              <i class="bi bi-toggle-on me-2"></i>
              Estado
            </label>
            <div class="form-check form-switch">
              <input
                class="form-check-input"
                type="checkbox"
                role="switch"
                [(ngModel)]="currentSite.activo"
                name="activo"
                id="siteActivo"
                [disabled]="isLoading"
              >
              <label class="form-check-label" for="siteActivo">
                <span class="status-indicator" [class.active]="currentSite.activo">
                  {{ currentSite.activo ? 'Activo' : 'Inactivo' }}
                </span>
                <small class="text-muted d-block mt-1">
                  {{ currentSite.activo ? 'Visible para asignaciones' : 'No disponible para nuevas asignaciones' }}
                </small>
              </label>
            </div>
          </div>

          <!-- Descripciones -->
          <div class="form-group mb-4">
            <div class="descripciones-header">
              <label class="form-label required">
                <i class="bi bi-card-text me-2"></i>
                Descripciones
              </label>
              <button
                type="button"
                class="btn btn-sm btn-outline-primary"
                (click)="addDescripcion()"
                [disabled]="isLoading"
              >
                <i class="bi bi-plus"></i>
                Agregar
              </button>
            </div>

            <div class="descripciones-container">
         <!-- Por esto: -->
<div
  *ngFor="let desc of descripcionesTemporal; let i = index"
  class="descripcion-item"
  [class.invalid]="formSubmitted && desc.value.trim() === ''"
>

                <div class="descripcion-input-wrapper">
  <input
  type="text"
  class="form-control descripcion-input"
  [(ngModel)]="desc.value"
  [name]="'descripcion' + i"
  placeholder="Ej: Oficina principal, Almacén central..."
  required
  [disabled]="isLoading"
>
                  <button
                    *ngIf="descripcionesTemporal.length > 1"
                    type="button"
                    class="btn btn-remove-desc"
                    (click)="removeDescripcion(i)"
                    [disabled]="isLoading"
                    [title]="'Eliminar descripción'"
                  >
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
<div *ngIf="formSubmitted && desc.value.trim() === ''" class="invalid-feedback">
                  La descripción no puede estar vacía
                </div>
              </div>
            </div>
<div *ngIf="showDescriptionsError()" class="invalid-feedback d-block">
  Debe ingresar al menos una descripción válida
</div>
            <div class="form-text">
              Agregue una o más descripciones para identificar claramente el site.
            </div>
          </div>

        </form>
      </div>

      <!-- Footer del Modal -->
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-outline-secondary"
          (click)="closeModal()"
          [disabled]="isLoading"
        >
          <i class="bi bi-x-lg"></i>
          Cancelar
        </button>
    <button
  type="submit"
  class="btn btn-primary"
  (click)="saveSite()"
  [disabled]="isLoading || !isFormValid()"
>
          <span *ngIf="!isLoading">
            <i class="bi" [class]="isEditMode ? 'bi-check-lg' : 'bi-plus-lg'"></i>
            {{ isEditMode ? 'Actualizar' : 'Crear' }}
          </span>
          <span *ngIf="isLoading" class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-2" role="status">
              <span class="visually-hidden">Guardando...</span>
            </div>
            Guardando...
          </span>
        </button>
      </div>
    </div>
  </div>
</div>
