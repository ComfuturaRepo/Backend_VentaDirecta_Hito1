<!-- usuarios.component.html -->
<div class="container-fluid mt-4">
  <!-- Encabezado -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-white border-bottom">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h5 class="mb-0">
            <i class="bi bi-people me-2"></i>Gestión de Usuarios
          </h5>
          <small class="text-muted">Administra los usuarios del sistema</small>
        </div>
        <div>
          <button class="btn btn-primary" (click)="openCreateModal()"  *appPermiso="'USUARIO_CREATE'"
>
            <i class="bi bi-plus-lg me-1"></i>Nuevo Usuario
          </button>
        </div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Buscar</label>
          <div class="input-group">
            <span class="input-group-text">
              <i class="bi bi-search"></i>
            </span>
            <input type="text"
                   class="form-control"
                   placeholder="Buscar por usuario o nombre..."
                   [(ngModel)]="searchTerm"
                   (keyup.enter)="aplicarFiltros()">
            <button class="btn btn-outline-secondary" (click)="aplicarFiltros()">
              <i class="bi bi-funnel"></i>
            </button>
          </div>
        </div>

        <div class="col-md-3">
          <label class="form-label">Estado</label>
          <select class="form-select" [(ngModel)]="filtroActivo" (change)="aplicarFiltros()">
            <option [ngValue]="null">Todos</option>
            <option [ngValue]="true">Activos</option>
            <option [ngValue]="false">Inactivos</option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Nivel</label>
          <select class="form-select" [(ngModel)]="filtroNivelId" (change)="aplicarFiltros()">
            <option [ngValue]="null">Todos los niveles</option>
            <option *ngFor="let nivel of niveles" [value]="nivel.id">
              {{ nivel.label }} {{ nivel.adicional }}
            </option>
          </select>
        </div>

        <div class="col-md-2 d-flex align-items-end">
          <button class="btn btn-outline-secondary w-100" (click)="limpiarFiltros()">
            <i class="bi bi-x-lg me-1"></i>Limpiar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla de usuarios -->
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th (click)="sort('idUsuario')" style="cursor: pointer; width: 70px;">
                ID
                <i *ngIf="sortBy === 'idUsuario'"
                   class="bi ms-1"
                   [class.bi-arrow-down]="sortDirection === 'desc'"
                   [class.bi-arrow-up]="sortDirection === 'asc'"></i>
              </th>
              <th (click)="sort('username')" style="cursor: pointer;">
                Usuario
                <i *ngIf="sortBy === 'username'"
                   class="bi ms-1"
                   [class.bi-arrow-down]="sortDirection === 'desc'"
                   [class.bi-arrow-up]="sortDirection === 'asc'"></i>
              </th>
              <th>Trabajador</th>
              <th>Nivel</th>
              <th (click)="sort('fechaCreacion')" style="cursor: pointer;">
                Fecha Creación
                <i *ngIf="sortBy === 'fechaCreacion'"
                   class="bi ms-1"
                   [class.bi-arrow-down]="sortDirection === 'desc'"
                   [class.bi-arrow-up]="sortDirection === 'asc'"></i>
              </th>
              <th>Estado</th>
              <th style="width: 120px;">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="isLoading">
              <td colspan="7" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Cargando...</span>
                </div>
              </td>
            </tr>

            <tr *ngIf="!isLoading && usuarios.length === 0">
              <td colspan="7" class="text-center py-5 text-muted">
                <i class="bi bi-people display-6 d-block mb-2"></i>
                No se encontraron usuarios
              </td>
            </tr>

            <tr *ngFor="let usuario of usuarios">
              <td class="fw-semibold">{{ usuario.idUsuario }}</td>
              <td>
                <div class="d-flex align-items-center">
                  <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                    {{ usuario.username.charAt(0).toUpperCase() }}
                  </div>
                  <span>{{ usuario.username }}</span>
                </div>
              </td>
              <td>{{ usuario.nombreTrabajador }}</td>
              <td>
              <!-- En el template, ya funciona porque cambiamos a public -->
<span class="badge" [ngClass]="usuarioService.getNivelBadgeClass(usuario.nivelNombre)">
  {{ usuario.nivelNombre }}
</span>
              </td>
              <td>{{ usuario.fechaCreacion | date:'dd/MM/yyyy' }}</td>
              <td>
                <span class="badge" [ngClass]="getEstadoClass(usuario.activo)">
                  {{ getEstadoText(usuario.activo) }}
                </span>
              </td>
              <td>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-primary"  *appPermiso="'USUARIO_EDIT'"
                          [title]="'Editar'"
                          (click)="openEditModal(usuario)">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn"
                          [ngClass]="usuario.activo ? 'btn-outline-warning' : 'btn-outline-success'"  *appPermiso="'USUARIO_TOGGLE'"
                          [title]="usuario.activo ? 'Desactivar' : 'Activar'"
                          (click)="toggleActivo(usuario)">
                    <i *ngIf="usuario.activo" class="bi bi-toggle-off"></i>
                    <i *ngIf="!usuario.activo" class="bi bi-toggle-on"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Paginación -->
      <div *ngIf="pageResponse && pageResponse.totalPages > 0" class="mt-4">
        <app-pagination
          [currentPage]="currentPage"
          [totalItems]="totalItems"
          [totalPages]="totalPages"
          [pageSize]="pageSize"
          [isLoading]="isLoading"
          (pageChange)="onPageChange($event)"
          (pageSizeChange)="onPageSizeChange($event)"
          (refresh)="onRefresh()">
        </app-pagination>
      </div>
    </div>
  </div>
</div>

<!-- Modal para crear/editar usuario -->
<div class="modal fade show d-block" *ngIf="showModal" [class.show]="showModal" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">{{ modalTitle }}</h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeModal()"></button>
      </div>

      <form [formGroup]="usuarioForm" (ngSubmit)="saveUsuario()">
        <div class="modal-body">
          <div class="row g-3">
            <!-- Username -->
            <div class="col-md-12">
              <label class="form-label">Correo electronico</label>
              <input type="text"
                     class="form-control"
                     [class.is-invalid]="isFieldInvalid('username')"
                     formControlName="username"
                     placeholder="Ingrese el nombre de usuario">
              <div *ngIf="isFieldInvalid('username')" class="invalid-feedback">
                {{ getErrorMessage('username') }}
              </div>
            </div>

            <!-- Trabajador -->
            <div class="col-md-6">
              <label class="form-label">Trabajador</label>
              <select class="form-select"
                      [class.is-invalid]="isFieldInvalid('trabajadorId')"
                      formControlName="trabajadorId">
                <option [ngValue]="null">Seleccionar trabajador</option>
                <option *ngFor="let trabajador of trabajadores" [value]="trabajador.id">
                  {{ trabajador.label }}
                </option>
              </select>
              <div *ngIf="isFieldInvalid('trabajadorId')" class="invalid-feedback">
                {{ getErrorMessage('trabajadorId') }}
              </div>
            </div>

            <!-- Nivel -->
            <div class="col-md-6">
              <label class="form-label">Nivel de Acceso</label>
              <select class="form-select"
                      [class.is-invalid]="isFieldInvalid('nivelId')"
                      formControlName="nivelId">
                <option [ngValue]="null">Seleccionar nivel</option>
                <option *ngFor="let nivel of niveles" [value]="nivel.id">
                  {{ nivel.label }} {{ nivel.adicional }}
                </option>
              </select>
              <div *ngIf="isFieldInvalid('nivelId')" class="invalid-feedback">
                {{ getErrorMessage('nivelId') }}
              </div>
            </div>

            <!-- Contraseña (solo para crear) -->
            <div *ngIf="modalMode === 'create'" class="col-md-6">
              <label class="form-label">Contraseña</label>
              <div class="input-group">
                <input [type]="showPassword ? 'text' : 'password'"
                       class="form-control"
                       [class.is-invalid]="isFieldInvalid('password')"
                       formControlName="password"
                       placeholder="Ingrese contraseña">
                <button class="btn btn-outline-secondary"
                        type="button"
                        (click)="showPassword = !showPassword">
                  <i class="bi" [class.bi-eye]="!showPassword" [class.bi-eye-slash]="showPassword"></i>
                </button>
              </div>
              <div *ngIf="isFieldInvalid('password')" class="invalid-feedback">
                {{ getErrorMessage('password') }}
              </div>
            </div>

            <!-- Confirmar Contraseña (solo para crear) -->
            <div *ngIf="modalMode === 'create'" class="col-md-6">
              <label class="form-label">Confirmar Contraseña</label>
              <div class="input-group">
                <input [type]="showConfirmPassword ? 'text' : 'password'"
                       class="form-control"
                       [class.is-invalid]="isFieldInvalid('confirmPassword')"
                       formControlName="confirmPassword"
                       placeholder="Confirmar contraseña">
                <button class="btn btn-outline-secondary"
                        type="button"
                        (click)="showConfirmPassword = !showConfirmPassword">
                  <i class="bi" [class.bi-eye]="!showConfirmPassword" [class.bi-eye-slash]="showConfirmPassword"></i>
                </button>
              </div>
              <div *ngIf="isFieldInvalid('confirmPassword')" class="invalid-feedback">
                {{ getErrorMessage('confirmPassword') }}
              </div>
            </div>

            <!-- Estado -->
            <div class="col-md-12">
              <div class="form-check form-switch">
                <input class="form-check-input"
                       type="checkbox"
                       role="switch"
                       id="activoSwitch"
                       formControlName="activo">
                <label class="form-check-label" for="activoSwitch">
                  Usuario activo
                </label>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancelar</button>
          <button type="submit"
                  class="btn btn-primary"
                  [disabled]="usuarioForm.invalid || isLoading">
            <span *ngIf="!isLoading">
              {{ modalMode === 'create' ? 'Crear' : 'Actualizar' }}
            </span>
            <span *ngIf="isLoading" class="spinner-border spinner-border-sm"></span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
