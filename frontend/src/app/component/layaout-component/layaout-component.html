<div class="layout-wrapper" [class.sidebar-collapsed]="isCollapsed" [class.mobile-open]="isMobileOpen">

  <!-- Sidebar Rojo-Azul -->
  <aside class="sidebar" [class.collapsed]="isCollapsed" [class.mobile-open]="isMobileOpen">

    <!-- Header con Logo -->
    <div class="sidebar-header">
      <div class="logo-container">
        <div class="logo-wrapper">
          <div *ngIf="logoUrl" class="logo-image-container">
            <img [src]="logoUrl" alt="Comfutura Logo" class="logo-image" />
          </div>
          <div *ngIf="!logoUrl" class="logo-fallback">
            <div class="logo-icon">
              <svg viewBox="0 0 32 32" fill="none">
                <rect x="4" y="4" width="24" height="24" rx="6" fill="url(#grad1)"/>
                <path d="M16 10L20 14L16 18L12 14L16 10Z" fill="white"/>
                <path d="M10 22L14 18L18 22L14 26L10 22Z" fill="white"/>
                <defs>
                  <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" stop-color="#dc2626"/>
                    <stop offset="100%" stop-color="#2563eb"/>
                  </linearGradient>
                </defs>
              </svg>
            </div>
          </div>
        </div>

        <div class="logo-text-container" *ngIf="!isCollapsed">
          <h1 class="logo-text">COMFUTURA</h1>
          <span class="logo-subtitle">Gestión Integral</span>
        </div>
      </div>

      <button class="collapse-btn" (click)="toggleCollapse()" [title]="isCollapsed ? 'Expandir menú' : 'Contraer menú'">
        <i class="bi" [ngClass]="isCollapsed ? 'bi-chevron-double-right' : 'bi-chevron-double-left'"></i>
      </button>
    </div>

    <!-- Menú Navegación -->
    <nav class="sidebar-menu">
      <ul>
        <!-- Dashboard -->
        <li *appPermiso="'DASHBOARD_VIEW'">
          <a routerLink="/dashboard" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }"
             (click)="closeMobile()">
            <div class="menu-icon-wrapper">
              <i class="bi bi-speedometer2"></i>
            </div>
            <span class="menu-label" *ngIf="!isCollapsed">Dashboard</span>
            <span class="menu-badge" *ngIf="!isCollapsed && hasNotifications">3</span>
          </a>
        </li>

        <!-- Separador para gestión -->
        <li class="menu-divider" *ngIf="!isCollapsed">
          <span class="divider-label">Gestión Principal</span>
        </li>

        <!-- Órdenes de Trabajo -->
        <li *appPermiso="'OT_VIEW'">
          <a routerLink="/ot" routerLinkActive="active" (click)="closeMobile()">
            <div class="menu-icon-wrapper">
              <i class="bi bi-clipboard-check"></i>
            </div>
            <span class="menu-label" *ngIf="!isCollapsed">Órdenes de Trabajo</span>
          </a>
        </li>

        <!-- Sites -->
        <li *appPermiso="'SITE_VIEW'">
          <a routerLink="/site" routerLinkActive="active" (click)="closeMobile()">
            <div class="menu-icon-wrapper">
              <i class="bi bi-geo-alt-fill"></i>
            </div>
            <span class="menu-label" *ngIf="!isCollapsed">Sites</span>
          </a>
        </li>

        <!-- Gestión Jefatura/Analista -->
        <li *appPermiso="['CONFIGURACION_VIEW', 'CONFIGURACION_MANAGE']" appPermisoCondicion="OR">
          <a routerLink="/gestion-jefatura-analista" routerLinkActive="active" (click)="closeMobile()">
            <div class="menu-icon-wrapper">
              <i class="bi bi-person-gear"></i>
            </div>
            <span class="menu-label" *ngIf="!isCollapsed">Gestión Jefatura/Analista</span>
          </a>
        </li>

        <!-- Órdenes de Compra -->
        <li *appPermiso="'OC_VIEW'">
          <a routerLink="/orden-compra" routerLinkActive="active" (click)="closeMobile()">
            <div class="menu-icon-wrapper">
              <i class="bi bi-cart-check-fill"></i>
            </div>
            <span class="menu-label" *ngIf="!isCollapsed">Órdenes de Compra</span>
          </a>
        </li>

        <!-- Separador para administración -->
        <li class="menu-divider" *ngIf="!isCollapsed">
          <span class="divider-label">Administración</span>
        </li>

        <!-- Usuarios -->
        <li *appPermiso="'USUARIO_VIEW'">
          <a routerLink="/usuarios" routerLinkActive="active" (click)="closeMobile()">
            <div class="menu-icon-wrapper">
              <i class="bi bi-people-fill"></i>
            </div>
            <span class="menu-label" *ngIf="!isCollapsed">Usuarios</span>
          </a>
        </li>

        <!-- Permisos -->
        <li *appPermiso="'PERMISO_ADMIN'">
          <a routerLink="/gestion-permisos" routerLinkActive="active" (click)="closeMobile()">
            <div class="menu-icon-wrapper">
              <i class="bi bi-shield-check"></i>
            </div>
            <span class="menu-label" *ngIf="!isCollapsed">Permisos</span>
          </a>
        </li>


        <!-- Permisos -->
        <li>
          <a routerLink="/ssoma" routerLinkActive="active" (click)="closeMobile()">
            <div class="menu-icon-wrapper">
              <i class="bi bi-shield-check"></i>
            </div>
            <span class="menu-label" *ngIf="!isCollapsed">Ssoma</span>
          </a>
        </li>

        <!-- Trabajadores -->
        <li *appPermiso="'TRABAJADOR_VIEW'">
          <a routerLink="/trabajador" routerLinkActive="active" (click)="closeMobile()">
            <div class="menu-icon-wrapper">
              <i class="bi bi-person-badge-fill"></i>
            </div>
            <span class="menu-label" *ngIf="!isCollapsed">Trabajadores</span>
          </a>
        </li>

        <!-- Clientes -->
        <li *appPermiso="'CLIENTE_VIEW'">
          <a routerLink="/cliente" routerLinkActive="active" (click)="closeMobile()">
            <div class="menu-icon-wrapper">
              <i class="bi bi-building"></i>
            </div>
            <span class="menu-label" *ngIf="!isCollapsed">Clientes</span>
          </a>
        </li>




        <!-- Separador para usuario -->
        <li class="menu-divider" *ngIf="!isCollapsed">
          <span class="divider-label">Mi Cuenta</span>
        </li>

        <!-- Perfil -->
        <li *appPermiso="'PERFIL_VIEW'">
          <a routerLink="/perfil" routerLinkActive="active" (click)="closeMobile()">
            <div class="menu-icon-wrapper">
              <i class="bi bi-person-circle"></i>
            </div>
            <span class="menu-label" *ngIf="!isCollapsed">Mi Perfil</span>
          </a>
        </li>


      </ul>
    </nav>

    <!-- Footer con Usuario -->
    <div class="sidebar-footer">
      <div class="user-profile" (click)="toggleUserMenu()" *ngIf="!isCollapsed">
        <div class="user-avatar" [ngClass]="userBadgeClass">
          {{ userInitial }}
          <div class="online-indicator"></div>
        </div>
        <div class="user-info">
          <div class="user-name">{{ nombreCompleto }}</div>
          <div class="user-role">{{ getCargo() || 'Usuario' }}</div>
          <div class="user-permiso-count" *ngIf="permisosCount > 0">
            <small class="text-muted">{{ permisosCount }} permiso{{ permisosCount !== 1 ? 's' : '' }}</small>
          </div>
        </div>
        <i class="bi bi-chevron-down user-dropdown-icon" [class.rotated]="showUserMenu"></i>
      </div>

      <!-- Menú desplegable del usuario -->
      <div class="user-menu-dropdown" *ngIf="showUserMenu && !isCollapsed">
        <a routerLink="/perfil" (click)="closeUserMenu()">
          <i class="bi bi-person-circle"></i>
          <span>Mi Perfil</span>
        </a>
        <a routerLink="/configuracion-personal" (click)="closeUserMenu()">
          <i class="bi bi-sliders"></i>
          <span>Configuración</span>
        </a>
        <div class="user-menu-divider"></div>
        <a href="javascript:void(0)" (click)="mostrarPermisosModal(); closeUserMenu()">
          <i class="bi bi-shield-check"></i>
          <span>Mis Permisos</span>
        </a>
        <div class="user-menu-divider"></div>
        <a href="javascript:void(0)" (click)="logout(); closeUserMenu()" class="logout-menu-item">
          <i class="bi bi-box-arrow-right"></i>
          <span>Cerrar Sesión</span>
        </a>
      </div>

      <div class="logout-section" *ngIf="!isCollapsed && !showUserMenu">
        <button class="logout-btn" (click)="logout()">
          <i class="bi bi-box-arrow-right"></i>
          <span>Cerrar Sesión</span>
        </button>
      </div>

      <!-- Versión colapsada -->
      <div class="user-avatar-collapsed" *ngIf="isCollapsed" [ngClass]="userBadgeClass" (click)="toggleCollapse()">
        {{ userInitial }}
      </div>
    </div>
  </aside>

  <!-- Overlay móvil -->
  <div class="mobile-overlay" *ngIf="isMobileOpen" (click)="closeMobile()"></div>

  <!-- Contenido Principal -->
  <main class="main-content">
    <!-- Top Bar -->
    <header class="top-bar">
      <div class="top-bar-left">
        <button class="menu-toggle" (click)="toggleMobile()" aria-label="Alternar menú">
          <i class="bi bi-list"></i>
        </button>

        <button class="collapse-toggle" (click)="toggleCollapse()" *ngIf="!isMobileOpen">
          <i class="bi" [ngClass]="isCollapsed ? 'bi-chevron-double-right' : 'bi-chevron-double-left'"></i>
        </button>

        <div class="breadcrumb">
          <ng-content select="[breadcrumb]"></ng-content>
        </div>
      </div>

      <div class="top-bar-right">
        <!-- Botón de permisos rápido -->
        <button class="topbar-btn permisos-btn" *ngIf="permisosCount > 0" (click)="mostrarPermisosModal()"
                title="Ver mis permisos">
          <i class="bi bi-shield-check"></i>
          <span class="permisos-badge">{{ permisosCount }}</span>
        </button>

        <!-- Notificaciones -->
        <button class="topbar-btn notification-btn" [class.has-notifications]="hasNotifications" (click)="toggleNotifications()">
          <i class="bi bi-bell"></i>
          <span class="notification-badge" *ngIf="hasNotifications">3</span>
        </button>

        <!-- Perfil de usuario -->
        <div class="user-dropdown">
          <div class="user-dropdown-trigger" (click)="toggleTopUserMenu()">
            <div class="user-mini-avatar" [ngClass]="userBadgeClass">
              {{ userInitial }}
            </div>
            <span class="user-mini-name">{{ nombreCompleto }}</span>
            <i class="bi bi-chevron-down"></i>
          </div>

          <!-- Menú desplegable top -->
          <div class="top-user-menu-dropdown" *ngIf="showTopUserMenu">
            <a routerLink="/perfil" (click)="closeTopUserMenu()">
              <i class="bi bi-person-circle"></i>
              <span>Mi Perfil</span>
            </a>
            <a routerLink="/configuracion-personal" (click)="closeTopUserMenu()">
              <i class="bi bi-sliders"></i>
              <span>Configuración</span>
            </a>
            <a href="javascript:void(0)" (click)="mostrarPermisosModal(); closeTopUserMenu()">
              <i class="bi bi-shield-check"></i>
              <span>Mis Permisos</span>
            </a>
            <div class="user-menu-divider"></div>
            <a href="javascript:void(0)" (click)="logout(); closeTopUserMenu()" class="logout-menu-item">
              <i class="bi bi-box-arrow-right"></i>
              <span>Cerrar Sesión</span>
            </a>
          </div>
        </div>
      </div>
    </header>

    <!-- Notificaciones Panel -->
    <div class="notifications-panel" *ngIf="showNotifications">
      <div class="notifications-header">
        <h3>Notificaciones</h3>
        <button class="close-notifications" (click)="closeNotifications()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      <div class="notifications-list">
        <!-- Contenido de notificaciones -->
        <div class="notification-item unread">
          <div class="notification-icon">
            <i class="bi bi-check-circle-fill text-success"></i>
          </div>
          <div class="notification-content">
            <p class="notification-text">Orden de trabajo #1234 ha sido aprobada</p>
            <span class="notification-time">Hace 5 minutos</span>
          </div>
        </div>
        <div class="notification-item unread">
          <div class="notification-icon">
            <i class="bi bi-exclamation-circle-fill text-warning"></i>
          </div>
          <div class="notification-content">
            <p class="notification-text">Site "Los Olivos" requiere atención</p>
            <span class="notification-time">Hace 1 hora</span>
          </div>
        </div>
        <div class="notification-item">
          <div class="notification-icon">
            <i class="bi bi-info-circle-fill text-info"></i>
          </div>
          <div class="notification-content">
            <p class="notification-text">Nueva actualización del sistema disponible</p>
            <span class="notification-time">Ayer</span>
          </div>
        </div>
      </div>
      <div class="notifications-footer">
        <a routerLink="/notificaciones" (click)="closeNotifications()">Ver todas las notificaciones</a>
      </div>
    </div>

    <!-- Contenido de la Página -->
    <div class="content-wrapper">
      <div class="page-header">
        <h1 class="page-title">
          <ng-content select="[page-title]"></ng-content>
        </h1>
        <div class="page-actions">
          <ng-content select="[page-actions]"></ng-content>
        </div>
      </div>

      <div class="content-area">
        <router-outlet></router-outlet>
      </div>
    </div>
  </main>

  <!-- Modal de permisos -->
  <div class="modal-backdrop fade show" *ngIf="mostrarModalPermisos"></div>
  <div class="modal fade" [class.show]="mostrarModalPermisos" id="permisosModal" tabindex="-1"
       [style.display]="mostrarModalPermisos ? 'block' : 'none'">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">
            <i class="bi bi-shield-check me-2"></i>
            Mis Permisos del Sistema
          </h5>
          <button type="button" class="btn-close btn-close-white" (click)="cerrarModalPermisos()"></button>
        </div>
        <div class="modal-body">
          <div *ngIf="cargandoPermisos" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Cargando permisos...</span>
            </div>
            <p class="mt-3">Cargando permisos...</p>
          </div>

          <div *ngIf="!cargandoPermisos">
            <div class="row mb-4">
              <div class="col-md-6">
                <div class="card border-0 bg-light">
                  <div class="card-body">
                    <h6 class="card-title">Resumen de Accesos</h6>
                    <div class="d-flex justify-content-between mb-2">
                      <span>Total de permisos:</span>
                      <strong>{{ permisosUsuario.length }}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                      <span>Nivel actual:</span>
                      <strong>{{ getNivel() }}</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                      <span>Área:</span>
                      <strong>{{ getArea() }}</strong>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card border-0 bg-light">
                  <div class="card-body">
                    <h6 class="card-title">Accesos por Categoría</h6>
                    <div class="d-flex justify-content-between mb-2">
                      <span>Dashboard:</span>
                      <span *ngIf="tienePermiso('DASHBOARD_VIEW')" class="badge bg-success">Permitido</span>
                      <span *ngIf="!tienePermiso('DASHBOARD_VIEW')" class="badge bg-secondary">No permitido</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                      <span>OTs:</span>
                      <span *ngIf="tienePermiso('OT_VIEW')" class="badge bg-success">Permitido</span>
                      <span *ngIf="!tienePermiso('OT_VIEW')" class="badge bg-secondary">No permitido</span>
                    </div>
                    <div class="d-flex justify-content-between">
                      <span>Administración:</span>
                      <span *ngIf="tieneAlgunPermiso(['USUARIO_VIEW', 'PERMISO_ADMIN', 'TRABAJADOR_VIEW'])"
                            class="badge bg-success">Permitido</span>
                      <span *ngIf="!tieneAlgunPermiso(['USUARIO_VIEW', 'PERMISO_ADMIN', 'TRABAJADOR_VIEW'])"
                            class="badge bg-secondary">No permitido</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <h6 class="mb-3">Lista de Permisos Asignados</h6>
            <div class="row">
              <div class="col-md-6 mb-3" *ngFor="let permiso of permisosUsuario">
                <div class="card h-100 border">
                  <div class="card-body">
                    <h6 class="card-title d-flex justify-content-between">
                      <span class="badge bg-success">Activo</span>
                    </h6>
                    <div class="d-flex justify-content-between align-items-center">
                      <small class="text-muted">Asignado automáticamente</small>
                      <i class="bi bi-check-circle text-success"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div *ngIf="permisosUsuario.length === 0" class="alert alert-warning">
              <i class="bi bi-exclamation-triangle me-2"></i>
              No tienes permisos asignados en el sistema. Contacta al administrador.
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="cerrarModalPermisos()">Cerrar</button>
          <button type="button" class="btn btn-primary" *appPermiso="'PERFIL_EDIT'"
                  (click)="irAPerfil(); cerrarModalPermisos()">
            <i class="bi bi-gear me-1"></i> Gestionar Accesos
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
